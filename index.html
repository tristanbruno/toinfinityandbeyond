<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>To Infinity and Beyond ‚Äì Interactive Worksheet</title>

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #0b1d33, #102a44);
      color: #ffffff;
      line-height: 1.6;
    }
    header {
      padding: 24px 16px;
      text-align: center;
      background: radial-gradient(circle at top, #1f3a5f, #0b1d33);
    }
    header h1 { margin: 0 0 8px 0; font-size: 2rem; }
    header p { max-width: 900px; margin: 6px auto; opacity: 0.92; }
    main { padding: 16px; max-width: 980px; margin: auto; }

    .nav {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 0 0 16px 0;
      flex-wrap: wrap;
    }

    .card {
      background: #ffffff;
      color: #000000;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    }
    h2, h3 { color: #1f3a5f; margin-top: 0; }
    a { color: #1f3a5f; word-break: break-word; }

    img {
      max-width: 100%;
      border-radius: 10px;
      margin: 12px 0;
      display: block;
    }

    .figure {
      margin: 12px 0;
      padding: 10px;
      background: #f6f8fc;
      border-radius: 10px;
      border: 1px solid #e3e7f2;
    }
    .figure img {
      width: 100%;
      height: auto;
      margin: 0;
      border-radius: 10px;
    }
    .figure .caption {
      font-size: 0.92rem;
      opacity: 0.85;
      margin-top: 6px;
      color: #1f3a5f;
    }

    label { font-weight: 600; display: block; margin-top: 14px; }

    textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
      resize: vertical;
      box-sizing: border-box;
    }

    button {
      padding: 12px 18px;
      background: #1f3a5f;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { background: #162a45; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .feedback {
      margin-top: 14px;
      padding: 12px;
      border-radius: 8px;
      background: #eef3fa;
      color: #000000;
      display: none;
      white-space: pre-wrap;
    }
    .answers {
      margin-top: 14px;
      padding: 14px;
      background: #e0e8f3;
      border-left: 5px solid #1f3a5f;
      display: none;
    }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef3fa;
      color: #1f3a5f;
      font-weight: 600;
      font-size: 0.9rem;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    .hint { font-size: 0.95rem; opacity: 0.9; margin-top: 6px; }
    ul { padding-left: 18px; }

    /* Counters */
    .counter{
      font-size: 0.92rem;
      opacity: 0.85;
      margin-top: 6px;
      color: #1f3a5f;
      display:flex;
      justify-content:flex-end;
    }
    .counter.bad{ color:#b00020; font-weight:600; opacity:0.95; }
    .counter.good{ color:#0b6b2c; font-weight:600; opacity:0.95; }

    /* stepper */
    .step {
      display: none;
      border: 1px solid #e3e7f2;
      border-radius: 12px;
      padding: 14px;
      background: #f7f9fe;
      margin-top: 12px;
    }
    .step.active { display: block; }
    .stepHeader {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .badge {
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background:#eef3fa;
      color:#1f3a5f;
      font-weight:700;
      font-size:0.85rem;
      white-space: nowrap;
    }

    /* gate modal */
    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modalBackdrop.show{ display:flex; }
    .modal {
      width: min(520px, 100%);
      background: #ffffff;
      color: #000000;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    .modal input{
      width: 100%;
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-top: 10px;
    }
    .row {
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    /* vocab game */
    .gameGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .gameQ{
      padding: 12px;
      border: 1px solid #e3e7f2;
      border-radius: 12px;
      background: #f7f9fe;
    }
    .choices label{
      display:block;
      font-weight: 500;
      margin-top: 8px;
    }
    .smallBtn{
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 8px;
    }

    .scorePill{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.22);
      color: #ffffff;
      font-weight: 700;
      font-size: 0.9rem;
      margin-top: 10px;
    }

    .gifBox{
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e3e7f2;
      background: #f7f9fe;
      margin-top: 12px;
    }
    .gifBox img{
      width: 100%;
      height: auto;
      display: block;
      margin: 0;
      border-radius: 0;
    }
  </style>
</head>

<body>

<header>
  <h1>üöÄ To Infinity and Beyond</h1>
  <p><span class="pill">Key question</span> Space conquest: a way to make money, a competition or a necessity?</p>
  <p><span class="pill">Theme</span> Space conquest: scientific innovations and responsibility</p>
  <div class="scorePill" id="scorePill">Score: 0</div>
</header>

<main>
  <div class="nav">
    <button type="button" onclick="showPage('worksheet')">Lesson 1 ‚Äì Worksheet (start here)</button>
    <button type="button" onclick="showLesson2()">Lesson 2 ‚Äì Video (locked)</button>
    <button type="button" onclick="showPage('vocab')" id="btnVocab" style="display:none;">Vocabulary game</button>
  </div>

  <!-- PAGE: WORKSHEET -->
  <section id="page-worksheet">
    <div class="card">
      <h2>Before you start</h2>
      <p>Use the following resource to find relevant information before answering the questions:</p>
      <p>
        <a href="https://www.spacefoundation.org/space_brief/us-space-law/" target="_blank" rel="noopener noreferrer">
          https://www.spacefoundation.org/space_brief/us-space-law/
        </a>
      </p>
      <p class="hint">Tip: focus on key ideas about the role of the government, private companies, and resource rights.</p>
    </div>

    <div class="card">
      <h2>Lesson 1 ‚Äì Asteroid Mining (Worksheet)</h2>
      <p class="hint">
        <strong>How it works:</strong> Answer <strong>one question at a time</strong>.
        You must write at least <strong>15 words</strong> and include <strong>key ideas</strong>.
        There is <strong>no maximum length</strong>.
      </p>

      <div class="figure">
        <img src="images/asteroid-infographic.jpeg" alt="Asteroid mining infographic" />
        <div class="caption">Study this infographic carefully before answering questions 1 and 2.</div>

        <!-- Step 1 -->
        <div class="step active" id="step-q1">
          <div class="stepHeader">
            <div><span class="badge">Question 1/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>1. Why are the 1958 Space Act and the 2015 Space Act both relevant today?</label>
          <textarea id="q1" rows="5" placeholder="Write in full sentences..."></textarea>
          <div class="counter" id="c_q1">Words: 0/15</div>

          <button type="button" onclick="submitOne('q1')">Submit Q1</button>
          <button type="button" class="smallBtn" id="next_q1" onclick="goNext('q1')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_q1"></div>

          <div class="answers" id="ans_q1">
            <h3>Correction (Q1)</h3>
            <p>The 1958 Space Act set up a public framework for U.S. space activities, while the 2015 U.S. Commercial Space Launch Competitiveness Act supports commercial involvement and resource rights. Together, they shape today‚Äôs debate about space as a public mission and a commercial opportunity.</p>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="step" id="step-q2">
          <div class="stepHeader">
            <div><span class="badge">Question 2/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>2. Explain the different steps of the process shown in the infographic.</label>
          <textarea id="q2" rows="5" placeholder="Describe the steps clearly..."></textarea>
          <div class="counter" id="c_q2">Words: 0/15</div>

          <button type="button" onclick="submitOne('q2')">Submit Q2</button>
          <button type="button" class="smallBtn" id="next_q2" onclick="goNext('q2')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_q2"></div>

          <div class="answers" id="ans_q2">
            <h3>Correction (Q2)</h3>
            <p>Possible steps: launch a spacecraft ‚Üí locate/approach an asteroid ‚Üí analyze composition ‚Üí confirm valuable resources (e.g., water) ‚Üí extract/collect materials ‚Üí use them in space or send information/resources back.</p>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="step" id="step-q3">
          <div class="stepHeader">
            <div><span class="badge">Question 3/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>3. Why is water important in space?</label>
          <textarea id="q3" rows="4" placeholder="Use at least two reasons..."></textarea>
          <div class="counter" id="c_q3">Words: 0/15</div>

          <button type="button" onclick="submitOne('q3')">Submit Q3</button>
          <button type="button" class="smallBtn" id="next_q3" onclick="goNext('q3')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_q3"></div>

          <div class="answers" id="ans_q3">
            <h3>Correction (Q3)</h3>
            <p>Water is essential for life support (drinking, oxygen) and it can be processed to make rocket propellant, enabling longer missions and refuelling in space.</p>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="step" id="step-q4">
          <div class="stepHeader">
            <div><span class="badge">Question 4/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>4. Does the document support or oppose asteroid mining? Why?</label>
          <textarea id="q4" rows="5" placeholder="State a position and justify with evidence..."></textarea>
          <div class="counter" id="c_q4">Words: 0/15</div>

          <button type="button" onclick="submitOne('q4')">Submit Q4</button>
          <button type="button" class="smallBtn" id="next_q4" onclick="goNext('q4')" style="display:none; margin-left:10px;">Finish</button>

          <div class="feedback" id="fb_q4"></div>

          <div class="answers" id="ans_q4">
            <h3>Correction (Q4)</h3>
            <p>Many such documents are generally supportive/optimistic because they highlight feasibility and benefits (especially water). A critical reading can also note what is missing (risks, ethics, environment). Any position is acceptable if justified with evidence from the document.</p>
          </div>
        </div>

        <!-- End message -->
        <div class="card" id="lesson1DoneCard" style="display:none;">
          <h2>Lesson 1 completed ‚úÖ</h2>
          <p><strong>Write that in your copybook ! ;)</strong></p>

          <h3>Summary / Course</h3>
          <p id="courseSummary" class="hint" style="opacity:1; color:#000;"></p>

          <p class="hint">Lesson 2 is locked with a code. If you finish early, use the vocabulary game.</p>
          <div class="row">
            <button type="button" class="smallBtn" onclick="showPage('vocab')">Go to Vocabulary game</button>
            <button type="button" class="smallBtn" onclick="showLesson2()">Unlock Lesson 2</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- PAGE: VIDEO -->
  <section id="page-video" style="display:none;">
    <div class="card">
      <h2>Lesson 2 ‚Äì Video: Asteroid Mining</h2>
      <p class="hint"><strong>This is Lesson 2.</strong> Work question by question. Minimum: 15 words (except the multiple choice).</p>

      <div style="position:relative; padding-top:56.25%; border-radius:12px; overflow:hidden;">
        <iframe
          src="https://www.youtube.com/embed/erF17yO9VsE"
          title="Asteroid Mining (YouTube)"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
          style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;">
        </iframe>
      </div>

      <div class="card" style="margin-top:14px;">
        <h3>Activities (Lesson 2)</h3>
        <p class="hint">Same rule as Lesson 1: you can go next after submitting, but you may see ‚Äúincomplete‚Äù feedback.</p>

        <!-- Step L2-1 -->
        <div class="step active" id="step-v1">
          <div class="stepHeader">
            <div><span class="badge">Activity 1/5</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>A1. In 2‚Äì3 sentences, explain what asteroid mining is.</label>
          <textarea id="v1" rows="3" placeholder="Write your answer..."></textarea>
          <div class="counter" id="c_v1">Words: 0/15</div>

          <button type="button" onclick="submitOne('v1')">Submit A1</button>
          <button type="button" class="smallBtn" id="next_v1" onclick="goNextLesson2('v1')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_v1"></div>
          <div class="answers" id="ans_v1">
            <h3>Correction (A1)</h3>
            <p>Asteroid mining is the idea of extracting useful resources (like water, metals, or minerals) from asteroids rather than only from Earth.</p>
          </div>
        </div>

        <!-- Step L2-2 -->
        <div class="step" id="step-v2">
          <div class="stepHeader">
            <div><span class="badge">Activity 2/5</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>A2. List two reasons why companies might want to mine asteroids.</label>
          <textarea id="v2" rows="2" placeholder="Write your answer..."></textarea>
          <div class="counter" id="c_v2">Words: 0/15</div>

          <button type="button" onclick="submitOne('v2')">Submit A2</button>
          <button type="button" class="smallBtn" id="next_v2" onclick="goNextLesson2('v2')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_v2"></div>
          <div class="answers" id="ans_v2">
            <h3>Correction (A2)</h3>
            <p>Examples: rare metals for industry; water for life support and fuel; reducing costs by using resources already in space; supporting long-term exploration.</p>
          </div>
        </div>

        <!-- Step L2-3 -->
        <div class="step" id="step-v3">
          <div class="stepHeader">
            <div><span class="badge">Activity 3/5</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>A3. True or False (justify briefly): Mining in space could help missions go further.</label>
          <textarea id="v3" rows="2" placeholder="True/False + justification..."></textarea>
          <div class="counter" id="c_v3">Words: 0/15</div>

          <button type="button" onclick="submitOne('v3')">Submit A3</button>
          <button type="button" class="smallBtn" id="next_v3" onclick="goNextLesson2('v3')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_v3"></div>
          <div class="answers" id="ans_v3">
            <h3>Correction (A3)</h3>
            <p>True: if resources are available in space, spacecraft can refuel or get supplies without returning to Earth, making longer missions easier.</p>
          </div>
        </div>

        <!-- Step L2-4 (MCQ) -->
        <div class="step" id="step-v4">
          <div class="stepHeader">
            <div><span class="badge">Activity 4/5</span></div>
            <div class="hint" style="margin:0;">Multiple choice</div>
          </div>

          <label>A4. Multiple choice: Which resource is often described as especially useful in space?</label>
          <div style="margin-top:6px;">
            <label style="font-weight:normal; margin-top:8px;"><input type="radio" name="v4" value="gold"> Gold</label><br>
            <label style="font-weight:normal; margin-top:8px;"><input type="radio" name="v4" value="water"> Water</label><br>
            <label style="font-weight:normal; margin-top:8px;"><input type="radio" name="v4" value="diamonds"> Diamonds</label><br>
            <label style="font-weight:normal; margin-top:8px;"><input type="radio" name="v4" value="coal"> Coal</label>
          </div>

          <button type="button" onclick="submitMCQv4()">Submit A4</button>
          <button type="button" class="smallBtn" id="next_v4" onclick="goNextLesson2('v4')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_v4"></div>
          <div class="answers" id="ans_v4">
            <h3>Correction (A4)</h3>
            <p>Water (because it supports life and can be turned into oxygen and fuel).</p>
          </div>
        </div>

        <!-- Step L2-5 -->
        <div class="step" id="step-v5">
          <div class="stepHeader">
            <div><span class="badge">Activity 5/5</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>A5. In your opinion, is asteroid mining mainly about money, competition, or necessity? Explain.</label>
          <textarea id="v5" rows="3" placeholder="Write your opinion + one argument..."></textarea>
          <div class="counter" id="c_v5">Words: 0/15</div>

          <button type="button" onclick="submitOne('v5')">Submit A5</button>
          <button type="button" class="smallBtn" id="next_v5" onclick="goNextLesson2('v5')" style="display:none; margin-left:10px;">Finish</button>

          <div class="feedback" id="fb_v5"></div>
          <div class="answers" id="ans_v5">
            <h3>Correction (A5)</h3>
            <p>Accept any well-argued answer (money/competition/necessity) if justified with ideas from the video.</p>
          </div>
        </div>

        <!-- End Lesson 2 -->
        <div class="card" id="lesson2DoneCard" style="display:none; margin-top:14px;">
          <h2>All done ‚úÖ</h2>
          <p><strong>Final score:</strong> <span id="finalScoreText"></span></p>
          <p class="hint" id="finalFeedback" style="opacity:1; color:#000;"></p>

          <div class="gifBox">
            <img id="congratsGif" alt="Congratulations GIF" />
          </div>

          <div class="row">
            <button type="button" class="smallBtn" onclick="showPage('worksheet')">Back to Lesson 1</button>
            <button type="button" class="smallBtn" onclick="showPage('vocab')">Vocabulary game</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- PAGE: VOCAB GAME -->
  <section id="page-vocab" style="display:none;">
    <div class="card">
      <h2>Vocabulary game (when you finish early)</h2>
      <p class="hint">Do this quietly while waiting for correction. Try to get 6/6.</p>

      <div class="gameGrid" id="gameGrid"></div>

      <div class="row">
        <button type="button" class="smallBtn" onclick="gradeGame()">Check my score</button>
        <button type="button" class="smallBtn" onclick="newGame()">New round</button>
        <button type="button" class="smallBtn" onclick="showPage('worksheet')">Back to Lesson 1</button>
      </div>

      <div class="feedback" id="fb_game"></div>
    </div>
  </section>

</main>

<!-- Lesson 2 code modal -->
<div class="modalBackdrop" id="codeModal">
  <div class="modal">
    <h2>Unlock Lesson 2</h2>
    <p>Enter the code given by your teacher.</p>
    <input id="codeInput" type="password" placeholder="Enter code‚Ä¶" autocomplete="off" />
    <div class="row">
      <button type="button" onclick="tryUnlock()">Unlock</button>
      <button type="button" onclick="closeModal()">Cancel</button>
    </div>
    <div class="feedback" id="fb_code" style="display:none;"></div>
  </div>
</div>

<script>
  /* ============================================================
     CONFIG
  ============================================================ */
  const LESSON2_CODE = "misterbruno";
  const MIN_WORDS = 15;

  // === IA (via Cloudflare Worker) ===
  const WORKER_URL = "https://toinfinityandbeyond.tristanbrunoedu.workers.dev";
  const USE_AI_VALIDATION = true; // mets false pour revenir √† la validation locale

  // External GIF (online is OK)
  const CONGRATS_GIF_URL = "https://media.giphy.com/media/111ebonMs90YLu/giphy.gif";

  // Scoring: accepted = 2 points, incomplete = 1 point
  const POINTS_ACCEPTED = 2;
  const POINTS_INCOMPLETE = 1;

  // Storage
  const STORE_PREFIX = "tiab_v2_";

  // Lesson 1 and Lesson 2 step order
  const stepOrderL1 = ["q1","q2","q3","q4"];
  const stepOrderL2 = ["v1","v2","v3","v4","v5"];

  const TEXT_FIELDS = ["q1","q2","q3","q4","v1","v2","v3","v5"];
  const RADIO_FIELDS = ["v4"];

  /* ============================================================
     NAV + LESSON 2 LOCK (UPDATED: no need to finish Lesson 1)
  ============================================================ */
  function showPage(which){
    const pages = ["worksheet","video","vocab"];
    pages.forEach(p => {
      const el = document.getElementById("page-" + p);
      if (el) el.style.display = (p === which ? "block" : "none");
    });
    window.scrollTo({top: 0, behavior: "smooth"});
  }

  function openModal(){
    document.getElementById("codeModal").classList.add("show");
    const fb = document.getElementById("fb_code");
    fb.style.display = "none";
    fb.textContent = "";
    document.getElementById("codeInput").value = "";
    document.getElementById("codeInput").focus();
  }

  function closeModal(){
    document.getElementById("codeModal").classList.remove("show");
  }

  function lesson2Unlocked(){
    try { return sessionStorage.getItem(STORE_PREFIX + "lesson2Unlocked") === "1"; }
    catch(e){ return false; }
  }

  function markLesson2Unlocked(){
    try { sessionStorage.setItem(STORE_PREFIX + "lesson2Unlocked","1"); } catch(e){}
  }

  function showLesson2(){
    if (!lesson2Unlocked()){
      openModal();
      return;
    }
    showPage("video");
  }

  function tryUnlock(){
    const v = (document.getElementById("codeInput").value || "").trim().toLowerCase();
    const fb = document.getElementById("fb_code");
    fb.style.display = "block";

    if (v === LESSON2_CODE){
      fb.textContent = "Unlocked ‚úÖ";
      markLesson2Unlocked();
      setTimeout(() => {
        closeModal();
        showPage("video");
      }, 350);
    } else {
      fb.textContent = "Wrong code. Try again.";
    }
  }

  /* ============================================================
     STORAGE HELPERS (NEW)
  ============================================================ */
  function k(key){ return STORE_PREFIX + key; }

  function storeSet(key, value){
    try { localStorage.setItem(k(key), value); } catch(e){}
  }
  function storeGet(key, fallback=""){
    try {
      const v = localStorage.getItem(k(key));
      return (v === null || v === undefined) ? fallback : v;
    } catch(e){ return fallback; }
  }
  function storeSetJSON(key, obj){
    try { localStorage.setItem(k(key), JSON.stringify(obj)); } catch(e){}
  }
  function storeGetJSON(key, fallback=null){
    try {
      const raw = localStorage.getItem(k(key));
      if (!raw) return fallback;
      return JSON.parse(raw);
    } catch(e){ return fallback; }
  }

  function statusKey(fieldId){ return "status_" + fieldId; }
  function answerKey(fieldId){ return "answer_" + fieldId; }
  function radioKey(name){ return "radio_" + name; }

  function setStatus(fieldId, obj){
    storeSetJSON(statusKey(fieldId), obj);
    updateScoreUI();
  }
  function getStatus(fieldId){
    return storeGetJSON(statusKey(fieldId), null);
  }

  function setAnswer(fieldId, value){
    storeSet(answerKey(fieldId), value);
  }
  function getAnswer(fieldId){
    return storeGet(answerKey(fieldId), "");
  }

  function setRadio(name, value){
    storeSet(radioKey(name), value);
  }
  function getRadio(name){
    return storeGet(radioKey(name), "");
  }

  /* ============================================================
     STEP CONTROL (LESSON 1)
  ============================================================ */
  function setActiveStepL1(id){
    stepOrderL1.forEach(q => {
      const box = document.getElementById("step-" + q);
      if (box) box.classList.toggle("active", q === id);
    });
    storeSet("activeStepL1", id);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function unlockVocabButton(){
    const b = document.getElementById("btnVocab");
    if (b) b.style.display = "inline-block";
  }

  function showCorrection(fieldId, show){
    const ans = document.getElementById("ans_" + fieldId);
    if (ans) ans.style.display = show ? "block" : "none";
  }

  function showNextButton(fieldId){
    const btn = document.getElementById("next_" + fieldId);
    if (btn) btn.style.display = "inline-block";
  }

  function hideNextButton(fieldId){
    const btn = document.getElementById("next_" + fieldId);
    if (btn) btn.style.display = "none";
  }

  function goNext(fieldId){
    const idx = stepOrderL1.indexOf(fieldId);
    if (idx >= 0 && idx < stepOrderL1.length - 1){
      setActiveStepL1(stepOrderL1[idx+1]);
      return;
    }
    finishLesson1();
  }

  /* ============================================================
     STEP CONTROL (LESSON 2)
  ============================================================ */
  function setActiveStepL2(id){
    stepOrderL2.forEach(q => {
      const box = document.getElementById("step-" + q);
      if (box) box.classList.toggle("active", q === id);
    });
    storeSet("activeStepL2", id);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function showNextButtonL2(fieldId){
    const btn = document.getElementById("next_" + fieldId);
    if (btn) btn.style.display = "inline-block";
  }
  function hideNextButtonL2(fieldId){
    const btn = document.getElementById("next_" + fieldId);
    if (btn) btn.style.display = "none";
  }
  function showCorrectionL2(fieldId, show){
    const ans = document.getElementById("ans_" + fieldId);
    if (ans) ans.style.display = show ? "block" : "none";
  }

  function goNextLesson2(fieldId){
    const idx = stepOrderL2.indexOf(fieldId);
    if (idx >= 0 && idx < stepOrderL2.length - 1){
      setActiveStepL2(stepOrderL2[idx+1]);
      return;
    }
    finishLesson2();
  }

  function setCorrectionVisible(fieldId, show){
    if (fieldId.startsWith("v")) showCorrectionL2(fieldId, show);
    else showCorrection(fieldId, show);
  }

  function setNextVisible(fieldId, show){
    if (fieldId.startsWith("v")) {
      if (show) showNextButtonL2(fieldId); else hideNextButtonL2(fieldId);
    } else {
      if (show) showNextButton(fieldId); else hideNextButton(fieldId);
    }
  }

  /* ============================================================
     IA VALIDATION (Cloudflare Worker)
     (Ajout : feedback structur√© + autorisation de passer √† l‚Äô√©tape suivante)
  ============================================================ */
  function getQuestionText(fieldId){
    const step = document.getElementById("step-" + fieldId);
    if (!step) return "";
    const lab = step.querySelector("label");
    return lab ? lab.textContent.trim() : "";
  }

  function getReferenceAnswerText(fieldId){
    const ans = document.getElementById("ans_" + fieldId);
    if (!ans) return "";
    return ans.textContent.replace(/\s+/g, " ").trim();
  }

  async function callAIValidator({ question, referenceAnswer, studentAnswer, minWords }){
    const payload = { question, referenceAnswer, studentAnswer, minWords };

    const r = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await r.json().catch(() => null);
    if (!r.ok) {
      const details = data && (data.details || data.error) ? (data.details || data.error) : ("HTTP " + r.status);
      throw new Error(details);
    }
    return data;
  }

  function pointsFromAIStatus(aiStatus){
    if (aiStatus === "ACCEPTED") return POINTS_ACCEPTED;
    if (aiStatus === "INCOMPLETE") return POINTS_INCOMPLETE;
    return 0; // REWORK
  }

  function formatAIFeedback(result){
    let txt = result && result.feedback ? String(result.feedback) : "";

    if (result && Array.isArray(result.missingIdeas) && result.missingIdeas.length > 0){
      txt += "\n\nMissing key ideas:\n";
      for (const idea of result.missingIdeas.slice(0, 6)){
        txt += "‚Ä¢ " + idea + "\n";
      }
    }

    if (result && result.status === "REWORK"){
      // Petit rappel bienveillant, sans bloquer le ton
      txt += (txt ? "\n\n" : "") + "Please rewrite in clear full sentences (on topic).";
    }

    return txt.trim();
  }

  function disableStepButtons(fieldId, disabled){
    const step = document.getElementById("step-" + fieldId);
    if (!step) return;
    step.querySelectorAll("button").forEach(b => { b.disabled = disabled; });
  }

  /* ============================================================
     IMPROVED VALIDATION (NO AI) ‚Äì CONCEPTS + NORMALIZATION
  ============================================================ */
  const STOP = new Set([
    "the","a","an","and","or","but","so","because","since","therefore","thus",
    "to","of","in","on","at","for","from","with","as","by","into","about",
    "is","are","was","were","be","been","being","it","this","that","these","those",
    "they","we","you","i","he","she","them","us","our","their","your","my"
  ]);

  function stripDiacritics(s){
    return (s || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  function normalizeText(s){
    let t = stripDiacritics(String(s || "").toLowerCase()).trim();
    t = t
      .replace(/\bcan't\b/g, "cannot")
      .replace(/\bdon't\b/g, "do not")
      .replace(/\bdoesn't\b/g, "does not")
      .replace(/\bdidn't\b/g, "did not")
      .replace(/\bwon't\b/g, "will not")
      .replace(/\bi'm\b/g, "i am")
      .replace(/\bit's\b/g, "it is")
      .replace(/\bthat's\b/g, "that is");

    t = t.replace(/[^a-z0-9'\s]+/g, " ").replace(/\s+/g, " ").trim();
    return t;
  }

  function tokens(text, { removeStop=true } = {}){
    const t = normalizeText(text);
    if (!t) return [];
    const raw = t.split(" ").filter(Boolean);
    if (!removeStop) return raw;

    return raw
      .map(w => {
        if (w.length > 5 && w.endsWith("ing")) return w.slice(0, -3);
        if (w.length > 4 && w.endsWith("ed"))  return w.slice(0, -2);
        if (w.length > 4 && w.endsWith("s"))   return w.slice(0, -1);
        return w;
      })
      .filter(w => !STOP.has(w));
  }

  function wordsCount(text){
    const t = normalizeText(text);
    if (!t) return 0;
    return t.split(/\s+/).filter(Boolean).length;
  }

  function uniqueRatio(wordList){
    const s = new Set(wordList);
    return s.size / Math.max(1, wordList.length);
  }

  function hasAnyVariant(normText, variants){
    return variants.some(v => normText.includes(v));
  }

  function conceptHits(normText, conceptVariants){
    let hits = 0;
    for (const variants of conceptVariants){
      if (hasAnyVariant(normText, variants)) hits++;
    }
    return hits;
  }

  function jaccardSimilarity(aText, bText){
    const A = new Set(tokens(aText));
    const B = new Set(tokens(bText));
    if (A.size === 0 || B.size === 0) return 0;
    let inter = 0;
    for (const x of A) if (B.has(x)) inter++;
    const union = A.size + B.size - inter;
    return inter / Math.max(1, union);
  }

  /* Anti-charabia (gentle but blocks lists/random) */
  function isSpam(text){
    const raw = (text || "").trim();
    if (raw.length < 10) return true;

    const compact = raw.toLowerCase().replace(/[\s\W_]+/g, "");
    if (compact.length < 10) return true;

    // A) long run of same character
    let run = 1;
    for (let i = 1; i < compact.length; i++) {
      if (compact[i] === compact[i - 1]) {
        run++;
        if (run >= 10) return true;
      } else run = 1;
    }

    // B) ababab pattern
    if (compact.length >= 24) {
      const a = compact[0], b = compact[1];
      if (a && b) {
        let ok = true;
        for (let i = 0; i < compact.length; i++) {
          if (compact[i] !== (i % 2 === 0 ? a : b)) { ok = false; break; }
        }
        if (ok) return true;
      }
    }

    // C) repeated same word too much
    const w = tokens(raw, { removeStop:false });
    if (w.length >= 12) {
      const counts = new Map();
      for (const x of w) {
        const clean = x.replace(/[^a-z0-9']/g, "");
        if (clean.length <= 2) continue;
        counts.set(clean, (counts.get(clean) || 0) + 1);
      }
      let max = 0;
      for (const v of counts.values()) max = Math.max(max, v);
      const ratio = max / Math.max(1, w.length);
      if (raw.length < 160 && ratio > 0.45) return true;
      if (raw.length >= 160 && ratio > 0.32) return true;
    }

    // D) keyword-list detector (only for short answers)
    const wc = wordsCount(raw);
    if (wc <= 35) {
      const nt = normalizeText(raw);
      const hasConnector = /(\bbecause\b|\bsince\b|\bso\b|\btherefore\b|\bbut\b)/.test(nt);
      const hasVerbish = /(\bis\b|\bare\b|\bwas\b|\bwere\b|\bcan\b|\bcould\b|\bshould\b|\bwill\b)/.test(nt);
      const hasPunct = /[.!?;]/.test(raw);
      const ur = uniqueRatio(tokens(raw, { removeStop:true }));
      if (!hasConnector && !hasVerbish && !hasPunct && ur > 0.75 && wc >= 15) return true;
    }

    return false;
  }

  /* Concept-based rules */
  const rules = {
    q1: {
      minWords: MIN_WORDS,
      minConcepts: 2,
      concepts: [
        ["1958", "space act 1958", "national aeronautics", "nasa", "public framework", "government role"],
        ["2015", "commercial space launch competitiveness", "commercial space act", "private companies", "private sector", "commercial involvement"],
        ["resource rights", "rights to resources", "space resources", "asteroid resources", "mining rights", "own the resources"],
        ["relevant today", "still relevant", "today's debate", "current debate", "nowadays", "modern space"]
      ],
      correctionAnchor: "1958 space act public framework nasa government 2015 commercial private resource rights debate"
    },
    q2: {
      minWords: MIN_WORDS,
      minConcepts: 3,
      concepts: [
        ["launch", "send a spacecraft", "spacecraft launch", "rocket launch"],
        ["locate", "find an asteroid", "identify an asteroid", "approach an asteroid", "reach the asteroid"],
        ["analyze", "analysis", "study its composition", "check composition", "measure composition"],
        ["extract", "collect", "mine", "mining", "harvest resources"],
        ["use in space", "use the resources", "refuel", "send back", "return", "support missions"]
      ],
      correctionAnchor: "launch locate approach asteroid analyze composition extract collect use in space refuel"
    },
    q3: {
      minWords: MIN_WORDS,
      minConcepts: 2,
      concepts: [
        ["life support", "drinking", "drink", "water to drink", "oxygen", "air", "keep astronauts alive"],
        ["fuel", "rocket fuel", "propellant", "refuel", "hydrogen", "oxygen for fuel", "longer missions"]
      ],
      correctionAnchor: "water life support oxygen drinking propellant fuel refuel longer missions"
    },
    q4: {
      minWords: MIN_WORDS,
      minConcepts: 2,
      concepts: [
        ["support", "in favor", "pro", "positive", "optimistic"],
        ["oppose", "against", "con", "negative", "critical"],
        ["because", "since", "therefore", "so"],
        ["evidence", "for example", "benefit", "risk", "ethics", "environment", "feasible", "missing"]
      ],
      correctionAnchor: "support or oppose because evidence benefits risks ethics environment feasible"
    },

    v1: {
      minWords: MIN_WORDS,
      minConcepts: 2,
      concepts: [
        ["asteroid", "asteroids"],
        ["mining", "mine", "extract", "take resources", "collect materials"],
        ["resources", "metals", "water", "minerals", "materials"]
      ],
      correctionAnchor: "asteroid mining extract resources metals water"
    },
    v2: {
      minWords: MIN_WORDS,
      minConcepts: 1,
      concepts: [
        ["metals", "rare metals", "industry", "profit", "money", "water", "fuel", "propellant", "missions", "exploration", "reduce costs"]
      ],
      correctionAnchor: "companies profit metals water fuel missions reduce costs exploration"
    },
    v3: {
      minWords: MIN_WORDS,
      minConcepts: 2,
      concepts: [
        ["true", "false"],
        ["because", "since", "so", "therefore", "this means"]
      ],
      correctionAnchor: "true because refuel supplies go further missions"
    },
    v5: {
      minWords: MIN_WORDS,
      minConcepts: 2,
      concepts: [
        ["money", "profit", "business"],
        ["competition", "race", "rivalry"],
        ["necessity", "need", "essential"],
        ["because", "since", "so", "therefore"]
      ],
      correctionAnchor: "opinion money competition necessity because argument"
    }
  };

  function passesGate(fieldId, value){
    const v = (value || "").trim();
    const r = rules[fieldId] || {};
    const wc = wordsCount(v);

    if (isSpam(v)){
      return { ok:false, type:"gibberish",
        msg:"‚ùå Not yet. Your answer is not readable enough (too repetitive / list-like). Write full sentences."
      };
    }
    if (r.minWords && wc < r.minWords){
      return { ok:false, type:"too_short", msg:`‚ùå Not yet. Please write at least ${r.minWords} words (no maximum).` };
    }

    if (r.concepts && r.minConcepts){
      const nt = normalizeText(v);
      const conceptVariants = r.concepts.map(list => list.map(x => normalizeText(x)));
      const hits = conceptHits(nt, conceptVariants);
      if (hits < r.minConcepts){
        return { ok:false, type:"missing_ideas",
          msg:"‚ùå Not yet. Add more key ideas (explain more clearly, with specific information)."
        };
      }
    }
    return { ok:true, type:"ok", msg:"" };
  }

  function gradeAnswer(fieldId, value){
    const r = rules[fieldId];
    if (!r) return { correct:true, level:"accepted" };

    const nt = normalizeText(value);
    const conceptVariants = (r.concepts || []).map(list => list.map(x => normalizeText(x)));
    const covered = conceptHits(nt, conceptVariants);
    const total = conceptVariants.length || 1;

    const sim = r.correctionAnchor ? jaccardSimilarity(value, r.correctionAnchor) : 0;

    const acceptedIfConcepts = Math.max(r.minConcepts || 1, Math.ceil(total * 0.45));
    const accepted = (covered >= acceptedIfConcepts) || (covered >= (r.minConcepts || 1) && sim >= 0.18);

    if (accepted) return { correct:true, level:"accepted", debug:{covered,total,sim} };
    return { correct:false, level:"incomplete", debug:{covered,total,sim} };
  }

  /* ============================================================
     COUNTERS (SAME UI, NOW PERSISTENT)
  ============================================================ */
  const counterMap = [
    { id:"q1", counter:"c_q1" },
    { id:"q2", counter:"c_q2" },
    { id:"q3", counter:"c_q3" },
    { id:"q4", counter:"c_q4" },
    { id:"v1", counter:"c_v1" },
    { id:"v2", counter:"c_v2" },
    { id:"v3", counter:"c_v3" },
    { id:"v5", counter:"c_v5" }
  ];

  function updateCounter(fieldId){
    const cfg = counterMap.find(x=>x.id===fieldId);
    if(!cfg) return;
    const el = document.getElementById(cfg.id);
    const c  = document.getElementById(cfg.counter);
    if(!el||!c) return;

    const wc = wordsCount(el.value);
    c.textContent = `Words: ${wc}/${MIN_WORDS}`;
    c.classList.remove("bad","good");

    if (el.value.trim().length===0) return;
    if (isSpam(el.value) || wc < MIN_WORDS) c.classList.add("bad");
    else c.classList.add("good");
  }

  function attachCounters(){
    counterMap.forEach(cfg=>{
      const el = document.getElementById(cfg.id);
      if(!el) return;
      el.addEventListener("input", ()=>{
        updateCounter(cfg.id);
        setAnswer(cfg.id, el.value); // persist
      });
      el.addEventListener("blur", ()=>{
        updateCounter(cfg.id);
        setAnswer(cfg.id, el.value); // persist
      });
      updateCounter(cfg.id);
    });
  }

  /* ============================================================
     SUBMIT (IA + mode local de secours)
  ============================================================ */
  async function submitOne(fieldId){
    const el = document.getElementById(fieldId);
    const fb = document.getElementById("fb_" + fieldId);
    if (!el || !fb) return;

    const value = el.value.trim();
    setAnswer(fieldId, el.value);

    fb.style.display = "block";
    setCorrectionVisible(fieldId, false);
    setNextVisible(fieldId, false);

    // Filtre local (√©vite de consommer des appels si r√©ponse insuffisante)
    const gate = passesGate(fieldId, value);
    if (!gate.ok){
      fb.textContent = gate.msg;
      return;
    }

    // Mode local (si besoin)
    if (!USE_AI_VALIDATION){
      const g = gradeAnswer(fieldId, value);

      if (g.correct){
        fb.textContent = "‚úÖ Accepted. You can click Next. (You can still improve style/precision.)";
        setCorrectionVisible(fieldId, false);
        setStatus(fieldId, { submitted:true, level:"accepted", points: POINTS_ACCEPTED, ts: Date.now() });
      } else {
        fb.textContent = "‚úÖ Submitted (you can click Next), but your answer is incomplete. Read the correction below, then improve it in your copybook.";
        setCorrectionVisible(fieldId, true);
        setStatus(fieldId, { submitted:true, level:"incomplete", points: POINTS_INCOMPLETE, ts: Date.now() });
      }

      unlockVocabButton();
      setNextVisible(fieldId, true);

      if (stepOrderL1.every(id => (getStatus(id)||{}).submitted)) finishLesson1(true);
      if (stepOrderL2.every(id => (getStatus(id)||{}).submitted)) finishLesson2(true);
      return;
    }

    // Mode IA
    disableStepButtons(fieldId, true);
    fb.textContent = "Checking with AI‚Ä¶";

    try {
      const question = getQuestionText(fieldId);
      const referenceAnswer = getReferenceAnswerText(fieldId);

      const result = await callAIValidator({
        question,
        referenceAnswer,
        studentAnswer: value,
        minWords: MIN_WORDS
      });

      const pts = pointsFromAIStatus(result.status);
      fb.textContent = formatAIFeedback(result);

      // Correction visible si INCOMPLETE ou REWORK
      setCorrectionVisible(fieldId, result.status !== "ACCEPTED");

      // Next selon allowNext
      setNextVisible(fieldId, !!result.allowNext);

      const level =
        result.status === "ACCEPTED" ? "accepted" :
        result.status === "INCOMPLETE" ? "incomplete" : "rework";

      setStatus(fieldId, {
        submitted: true,
        level,
        points: pts,
        ts: Date.now(),
        ai: result
      });

      unlockVocabButton();

      if (stepOrderL1.every(id => (getStatus(id)||{}).submitted)) finishLesson1(true);
      if (stepOrderL2.every(id => (getStatus(id)||{}).submitted)) finishLesson2(true);

    } catch (e) {
      // Panne IA : ne pas bloquer les √©l√®ves
      fb.textContent =
        "AI check failed (network/service). Your answer is saved. You can click Next. (Teacher may review later.)";

      setCorrectionVisible(fieldId, false);
      setNextVisible(fieldId, true);

      setStatus(fieldId, {
        submitted:true,
        level:"incomplete",
        points: POINTS_INCOMPLETE,
        ts: Date.now(),
        aiError: String(e?.message || e)
      });

      unlockVocabButton();
    } finally {
      disableStepButtons(fieldId, false);
    }
  }

  /* ============================================================
     FINISH LESSONS (inchang√©)
  ============================================================ */
  function finishLesson1(silent=false){
    storeSet("lesson1Done","1");
    document.getElementById("lesson1DoneCard").style.display = "block";

    const summary =
      "The 1958 Space Act created a public framework for U.S. space activities, while the 2015 Commercial Space Launch Competitiveness Act supports private companies and resource rights. " +
      "Asteroid mining can involve launching a spacecraft, locating and approaching an asteroid, analysing its composition, confirming valuable resources (especially water), and extracting/collecting materials to use in space. " +
      "Water is crucial because it supports life (drinking/oxygen) and can be processed into propellant for refuelling, making longer missions possible. " +
      "Many documents are optimistic about asteroid mining because they highlight feasibility and benefits, but a critical view can also mention risks, ethics, and environmental issues. " +
      "In all cases, a clear opinion must be justified with evidence.";
    const p = document.getElementById("courseSummary");
    if (p) p.textContent = summary;

    unlockVocabButton();
    updateScoreUI();

    if (!silent) window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  function getRadioValue(name){
    const el = document.querySelector('input[name="' + name + '"]:checked');
    return el ? el.value : '';
  }

  function submitMCQv4(){
    const fb = document.getElementById("fb_v4");
    const picked = getRadioValue("v4");
    fb.style.display = "block";
    showCorrectionL2("v4", false);
    hideNextButtonL2("v4");

    if (!picked){
      fb.textContent = "‚ùå Not yet. Please choose one option.";
      return;
    }

    setRadio("v4", picked);

    if (picked === "water"){
      fb.textContent = "‚úÖ Accepted. You can click Next.";
      showCorrectionL2("v4", false);
      setStatus("v4", { submitted:true, level:"accepted", points: POINTS_ACCEPTED, ts: Date.now() });
    } else {
      fb.textContent = "‚úÖ Submitted (you can click Next), but incorrect. Read the correction below.";
      showCorrectionL2("v4", true);
      setStatus("v4", { submitted:true, level:"incomplete", points: 0, ts: Date.now() });
    }

    unlockVocabButton();
    showNextButtonL2("v4");
    updateScoreUI();

    if (stepOrderL2.every(id => (getStatus(id)||{}).submitted)) finishLesson2(true);
  }

  function finishLesson2(silent=false){
    storeSet("lesson2Done","1");

    const card = document.getElementById("lesson2DoneCard");
    card.style.display = "block";

    const total = getTotalScore();
    const max = getMaxScore();

    document.getElementById("finalScoreText").textContent = `${total} / ${max}`;

    const pct = max > 0 ? (total / max) : 0;
    let msg = "Well done. Keep improving clarity and evidence.";
    if (pct >= 0.85) msg = "Excellent work. Your answers are clear and complete.";
    else if (pct >= 0.65) msg = "Good work. A few answers could be more precise, but overall solid.";
    else if (pct >= 0.45) msg = "Good effort. Read the corrections and add more key ideas next time.";
    else msg = "Keep going. Use the corrections to improve your answers step by step.";

    document.getElementById("finalFeedback").textContent = msg;
    document.getElementById("congratsGif").src = CONGRATS_GIF_URL;

    unlockVocabButton();
    updateScoreUI();

    if (!silent) window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  /* ============================================================
     SCORE (TOTAL Lesson 1 + Lesson 2)
  ============================================================ */
  function getMaxScore(){
    return (4 + 5) * 2;
  }

  function getTotalScore(){
    let sum = 0;
    const all = [...stepOrderL1, ...stepOrderL2];
    for (const id of all){
      const st = getStatus(id);
      if (st && st.submitted) sum += Number(st.points || 0);
    }
    return sum;
  }

  function updateScoreUI(){
    const pill = document.getElementById("scorePill");
    if (!pill) return;
    pill.textContent = `Score: ${getTotalScore()} / ${getMaxScore()}`;
  }

  /* ============================================================
     RESTORE STATE ON LOAD (IA-friendly)
  ============================================================ */
  function restoreAnswers(){
    // restore textareas
    for (const id of TEXT_FIELDS){
      const el = document.getElementById(id);
      if (!el) continue;
      const v = getAnswer(id);
      if (v) el.value = v;
      updateCounter(id);
    }

    // restore radio v4
    const v4 = getRadio("v4");
    if (v4){
      const el = document.querySelector(`input[name="v4"][value="${v4}"]`);
      if (el) el.checked = true;
    }

    // restore submitted statuses
    const all = [...stepOrderL1, ...stepOrderL2];
    for (const id of all){
      const st = getStatus(id);
      if (!st || !st.submitted) continue;

      const fb = document.getElementById("fb_" + id);
      if (fb){
        fb.style.display = "block";
        if (st.ai && typeof st.ai === "object"){
          fb.textContent = formatAIFeedback(st.ai);
        } else {
          if (st.level === "accepted") fb.textContent = "‚úÖ Already submitted. You can click Next.";
          else if (st.level === "rework") fb.textContent = "‚ùå Needs rework. Please improve your answer.";
          else fb.textContent = "‚úÖ Already submitted, but incomplete. Read the correction below.";
        }
      }

      // show correction if not accepted
      setCorrectionVisible(id, st.level !== "accepted");

      // next button policy
      if (st.ai && st.ai.allowNext === false) setNextVisible(id, false);
      else setNextVisible(id, true);
    }

    // restore active steps
    const activeL1 = storeGet("activeStepL1", "q1");
    const activeL2 = storeGet("activeStepL2", "v1");
    if (stepOrderL1.includes(activeL1)) setActiveStepL1(activeL1);
    if (stepOrderL2.includes(activeL2)) setActiveStepL2(activeL2);

    // restore lesson completion cards
    const l1done = storeGet("lesson1Done","0") === "1";
    if (l1done) finishLesson1(true);

    const l2done = storeGet("lesson2Done","0") === "1";
    if (l2done) finishLesson2(true);

    // show vocab button if any submission exists
    const anySubmitted = [...stepOrderL1, ...stepOrderL2].some(id => (getStatus(id)||{}).submitted);
    if (anySubmitted) unlockVocabButton();

    updateScoreUI();
  }

  /* ============================================================
     VOCAB GAME (FIXED: no duplicates, random correct position)
  ============================================================ */
  const vocabItems = [
    { term:"to extract", def:"to remove (a material) from something" },
    { term:"resources", def:"useful materials that can be used or sold" },
    { term:"to refuel", def:"to fill a vehicle with fuel again" },
    { term:"propellant", def:"substance used to move a rocket forward" },
    { term:"life support", def:"systems that keep humans alive (air/water/etc.)" },
    { term:"to launch", def:"to send a rocket/spacecraft into space" }
  ];

  function shuffle(arr){
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function pickDistractors(correctDef, allDefs, n=3){
    const pool = allDefs.filter(d => d !== correctDef);
    const chosen = [];
    const used = new Set();

    for (const d of pool){
      if (!used.has(d)) used.add(d);
    }
    const uniqPool = Array.from(used);

    const shuffled = shuffle(uniqPool);
    for (const d of shuffled){
      if (chosen.length >= n) break;
      chosen.push(d);
    }
    return chosen;
  }

  function newGame(){
    const grid = document.getElementById("gameGrid");
    const fb = document.getElementById("fb_game");
    fb.style.display = "none";
    fb.textContent = "";
    grid.innerHTML = "";

    const terms = shuffle(vocabItems);
    const allDefs = vocabItems.map(x=>x.def);

    terms.forEach((item, idx)=>{
      const qId = "vg_" + idx;
      const correct = item.def;

      const distractors = pickDistractors(correct, allDefs, 3);
      const options = shuffle([correct, ...distractors]);

      const box = document.createElement("div");
      box.className = "gameQ";
      box.innerHTML = `
        <div class="stepHeader">
          <div><span class="badge">Vocab ${idx+1}/6</span></div>
          <div class="hint" style="margin:0;">Choose the correct definition</div>
        </div>
        <div style="font-weight:800; color:#1f3a5f; font-size:1.05rem;">${escapeHtml(item.term)}</div>
        <div class="choices" style="margin-top:8px;">
          ${options.map((c)=>`
            <label>
              <input type="radio" name="${qId}" value="${escapeHtml(c)}">
              ${escapeHtml(c)}
            </label>
          `).join("")}
        </div>
        <input type="hidden" id="${qId}_ans" value="${escapeHtml(correct)}">
      `;
      grid.appendChild(box);
    });
  }

  function gradeGame(){
    const fb = document.getElementById("fb_game");
    let score = 0;

    for (let i=0;i<6;i++){
      const qId = "vg_" + i;
      const correct = (document.getElementById(qId+"_ans").value || "");
      const pickedEl = document.querySelector(`input[name="${qId}"]:checked`);
      const picked = pickedEl ? pickedEl.value : "";
      if (picked && picked === correct) score++;
    }

    fb.style.display = "block";
    fb.textContent = `Score: ${score}/6. ${score>=5 ? "Great work." : "Try again."}`;
  }

  /* ============================================================
     INIT
  ============================================================ */
  attachCounters();

  // Persist radio choice
  document.querySelectorAll('input[name="v4"]').forEach(r => {
    r.addEventListener("change", ()=> setRadio("v4", getRadioValue("v4")));
  });

  newGame();
  restoreAnswers();
</script>

</body>
</html>
