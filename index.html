<script>
  let worksheetAttempts = 0;
  let videoAttempts = 0;

  const rules = {
    q1: { minWords: 25, mustHaveAll: ['1958'], mustHaveAny: ['2015','commercial','private','company','companies','resources','mining','space act'] },
    q2: { minWords: 25, keywordsAnyMin: { list: ['launch','spacecraft','probe','locate','find','asteroid','analy','analyze','analysis','extract','mine','mining','data','process','steps'], n: 3 } },
    q3: { minWords: 12, keywordsAnyMin: { list: ['oxygen','fuel','rocket','drinking','drink','life support','propellant','water'], n: 2 } },
    q4: { minWords: 25, keywordsAnyMin: { list: ['support','oppose','optimistic','critical','pro','con','because','since','evidence','benefit','risk'], n: 2 } },

    v1: { minWords: 20, keywordsAnyMin: { list: ['asteroid','mining','mine','extract','resources','metals','water'], n: 2 } },
    v2: { minWords: 10 },
    v3: { minWords: 8, mustHaveAny: ['true','false'], alsoAny: ['because','since','so'] },
    v5: { minWords: 20, keywordsAnyMin: { list: ['money','profit','competition','race','necessity','need','because','future','missions','resources'], n: 2 } }
  };

  function showPage(which) {
    const w = document.getElementById('page-worksheet');
    const v = document.getElementById('page-video');
    if (which === 'video') { w.style.display='none'; v.style.display='block'; }
    else { v.style.display='none'; w.style.display='block'; }
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function norm(s){ return (s||'').toLowerCase().trim(); }
  function wordsCount(text){
    const t = norm(text);
    if (!t) return 0;
    return t.split(/\s+/).filter(Boolean).length;
  }
  function countMatches(text, keywords){
    const t = norm(text);
    return keywords.reduce((acc,k)=>acc+(t.includes(k)?1:0),0);
  }
  function hasAll(text, list){
    const t = norm(text);
    return list.every(k=>t.includes(k));
  }
  function hasAny(text, list){
    const t = norm(text);
    return list.some(k=>t.includes(k));
  }

  // Anti-spam: long same-char run, ababab, very low unique ratio
  function isSpam(text){
    const raw = (text||'').trim();
    if (raw.length < 10) return false;

    const t = raw.toLowerCase().replace(/\s+/g,'');
    if (t.length < 10) return false;

    // long run of same char
    let run = 1;
    for (let i=1;i<t.length;i++){
      if (t[i]===t[i-1]) { run++; if (run>=8) return true; }
      else run = 1;
    }

    // ababab pattern
    if (t.length>=12){
      const a=t[0], b=t[1];
      if (a && b){
        let ok=true;
        for (let i=0;i<t.length;i++){
          const expected = (i%2===0)?a:b;
          if (t[i]!==expected){ ok=false; break; }
        }
        if (ok) return true;
      }
    }

    // low unique ratio
    const uniq = new Set(t.split(''));
    const ratio = uniq.size / t.length;
    if (ratio < 0.18) return true;

    return false;
  }

  function validate(fieldId, value){
    const r = rules[fieldId] || {};
    const wc = wordsCount(value);

    if (isSpam(value)) {
      return { ok:false, reason:'Your answer looks incomplete (random letters/repetition). Write full sentences.' };
    }
    if (r.minWords && wc < r.minWords) {
      return { ok:false, reason:`Please write at least ${r.minWords} words.` };
    }
    if (r.mustHaveAll && !hasAll(value, r.mustHaveAll)) {
      return { ok:false, reason:`Missing key element(s): ${r.mustHaveAll.join(', ')}.` };
    }
    if (r.mustHaveAny && !hasAny(value, r.mustHaveAny)) {
      return { ok:false, reason:'Add at least one relevant keyword (e.g., 2015 / commercial / private / resourcesâ€¦).'};
    }
    if (r.alsoAny && !hasAny(value, r.alsoAny)) {
      return { ok:false, reason:'Add a connector to justify your answer (because / since / so).'};
    }
    if (r.keywordsAnyMin) {
      const n = countMatches(value, r.keywordsAnyMin.list);
      if (n < r.keywordsAnyMin.n) {
        return { ok:false, reason:`Add more specific vocabulary (at least ${r.keywordsAnyMin.n} keywords).` };
      }
    }
    return { ok:true, reason:'' };
  }

  function getRadioValue(name){
    const el = document.querySelector('input[name="'+name+'"]:checked');
    return el ? el.value : '';
  }

  // Counters
  const counterMap = [
    { id:'q1', counter:'c_q1', min:25 },
    { id:'q2', counter:'c_q2', min:25 },
    { id:'q3', counter:'c_q3', min:12 },
    { id:'q4', counter:'c_q4', min:25 },
    { id:'v1', counter:'c_v1', min:20 },
    { id:'v2', counter:'c_v2', min:10 },
    { id:'v3', counter:'c_v3', min:8 },
    { id:'v5', counter:'c_v5', min:20 }
  ];

  function updateCounter(fieldId){
    const cfg = counterMap.find(x=>x.id===fieldId);
    if(!cfg) return;
    const el = document.getElementById(cfg.id);
    const c  = document.getElementById(cfg.counter);
    if(!el||!c) return;

    const wc = wordsCount(el.value);
    c.textContent = `Words: ${wc}/${cfg.min}`;
    c.classList.remove('bad','good');

    if (el.value.trim().length===0) return;

    if (isSpam(el.value)){
      c.classList.add('bad');
      c.textContent = `Words: ${wc}/${cfg.min} â€” write full sentences`;
      return;
    }

    if (wc>=cfg.min) c.classList.add('good');
    else c.classList.add('bad');
  }

  function attachCounters(){
    counterMap.forEach(cfg=>{
      const el = document.getElementById(cfg.id);
      if(!el) return;
      el.addEventListener('input', ()=>updateCounter(cfg.id));
      el.addEventListener('blur',  ()=>updateCounter(cfg.id));
      updateCounter(cfg.id);
    });
  }

  function checkWorksheetAnswers() {
    const q1 = document.getElementById('q1').value.trim();
    const q2 = document.getElementById('q2').value.trim();
    const q3 = document.getElementById('q3').value.trim();
    const q4 = document.getElementById('q4').value.trim();

    const feedback = document.getElementById('worksheetFeedback');
    const answers  = document.getElementById('worksheetAnswers');

    if (!q1 || !q2 || !q3 || !q4) {
      feedback.style.display = 'block';
      feedback.textContent = 'Please answer all questions before submitting.';
      return;
    }

    worksheetAttempts++;

    const v1 = validate('q1', q1);
    const v2 = validate('q2', q2);
    const v3 = validate('q3', q3);
    const v4 = validate('q4', q4);

    const problems = [v1,v2,v3,v4].filter(x=>!x.ok).map(x=>x.reason);

    // IMPORTANT: even after 3 attempts, no unlock if spam/too short
    if (problems.length > 0) {
      feedback.style.display = 'block';
      feedback.textContent = (worksheetAttempts < 3)
        ? ('Good attempt ðŸ‘ Improve your answers: ' + problems[0])
        : ('Almost there ðŸ‘ You still need to meet the minimum requirements: ' + problems[0]);
      return;
    }

    feedback.style.display = 'block';
    feedback.textContent = 'Well done for trying ðŸ‘ Here are the suggested answers to help you.';
    answers.style.display = 'block';

    document.getElementById('ws1').textContent = q1;
    document.getElementById('ws2').textContent = q2;
    document.getElementById('ws3').textContent = q3;
    document.getElementById('ws4').textContent = q4;
    document.getElementById('worksheetSummary').style.display = 'block';
  }

  function checkVideoAnswers() {
    const v1t = document.getElementById('v1').value.trim();
    const v2t = document.getElementById('v2').value.trim();
    const v3t = document.getElementById('v3').value.trim();
    const v4  = getRadioValue('v4');
    const v5t = document.getElementById('v5').value.trim();

    const feedback = document.getElementById('videoFeedback');
    const answers  = document.getElementById('videoAnswers');

    if (!v1t || !v2t || !v3t || !v4 || !v5t) {
      feedback.style.display = 'block';
      feedback.textContent = 'Please answer all activities before submitting.';
      return;
    }

    videoAttempts++;

    const a1 = validate('v1', v1t);
    const a2 = validate('v2', v2t);
    const a3 = validate('v3', v3t);
    const a5 = validate('v5', v5t);

    const problems = [a1,a2,a3,a5].filter(x=>!x.ok).map(x=>x.reason);
    if (v4 !== 'water') problems.unshift('For A4, choose the option that matches the video (hint: it helps life + fuel).');

    if (problems.length > 0) {
      feedback.style.display = 'block';
      feedback.textContent = (videoAttempts < 3)
        ? ('Good attempt ðŸ‘ Improve your answers: ' + problems[0])
        : ('Almost there ðŸ‘ You still need to meet the minimum requirements: ' + problems[0]);
      return;
    }

    feedback.style.display = 'block';
    feedback.textContent = 'Well done for trying ðŸ‘ Here are the suggested answers to help you.';
    answers.style.display = 'block';

    document.getElementById('vs1').textContent = v1t;
    document.getElementById('vs2').textContent = v2t;
    document.getElementById('vs3').textContent = v3t;
    document.getElementById('vs4').textContent = v4;
    document.getElementById('vs5').textContent = v5t;
    document.getElementById('videoSummary').style.display = 'block';
  }

  attachCounters();
</script>
