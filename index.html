<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>To Infinity and Beyond ‚Äì Interactive Worksheet</title>

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #0b1d33, #102a44);
      color: #ffffff;
      line-height: 1.6;
    }
    header {
      padding: 24px 16px;
      text-align: center;
      background: radial-gradient(circle at top, #1f3a5f, #0b1d33);
    }
    header h1 { margin: 0 0 8px 0; font-size: 2rem; }
    header p { max-width: 900px; margin: 6px auto; opacity: 0.92; }
    main { padding: 16px; max-width: 980px; margin: auto; }

    .nav {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 0 0 16px 0;
      flex-wrap: wrap;
    }

    .card {
      background: #ffffff;
      color: #000000;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    }
    h2, h3 { color: #1f3a5f; margin-top: 0; }
    a { color: #1f3a5f; word-break: break-word; }

    img {
      max-width: 100%;
      border-radius: 10px;
      margin: 12px 0;
      display: block;
    }

    .figure {
      margin: 12px 0;
      padding: 10px;
      background: #f6f8fc;
      border-radius: 10px;
      border: 1px solid #e3e7f2;
    }
    .figure img {
      width: 100%;
      height: auto;
      margin: 0;
      border-radius: 10px;
    }
    .figure .caption {
      font-size: 0.92rem;
      opacity: 0.85;
      margin-top: 6px;
      color: #1f3a5f;
    }

    label { font-weight: 600; display: block; margin-top: 14px; }

    textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
      resize: vertical;
      box-sizing: border-box;
    }

    button {
      padding: 12px 18px;
      background: #1f3a5f;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { background: #162a45; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .feedback {
      margin-top: 14px;
      padding: 12px;
      border-radius: 8px;
      background: #eef3fa;
      color: #000000;
      display: none;
      white-space: pre-wrap;
    }
    .answers {
      margin-top: 14px;
      padding: 14px;
      background: #e0e8f3;
      border-left: 5px solid #1f3a5f;
      display: none;
    }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef3fa;
      color: #1f3a5f;
      font-weight: 600;
      font-size: 0.9rem;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    .hint { font-size: 0.95rem; opacity: 0.9; margin-top: 6px; }
    ul { padding-left: 18px; }

    .counter{
      font-size: 0.92rem;
      opacity: 0.85;
      margin-top: 6px;
      color: #1f3a5f;
      display:flex;
      justify-content:flex-end;
    }
    .counter.bad{ color:#b00020; font-weight:600; opacity:0.95; }
    .counter.good{ color:#0b6b2c; font-weight:600; opacity:0.95; }

    .step {
      display: none;
      border: 1px solid #e3e7f2;
      border-radius: 12px;
      padding: 14px;
      background: #f7f9fe;
      margin-top: 12px;
    }
    .step.active { display: block; }
    .stepHeader {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .badge {
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background:#eef3fa;
      color:#1f3a5f;
      font-weight:700;
      font-size:0.85rem;
      white-space: nowrap;
    }

    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modalBackdrop.show{ display:flex; }
    .modal {
      width: min(520px, 100%);
      background: #ffffff;
      color: #000000;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    .modal input{
      width: 100%;
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-top: 10px;
    }
    .row {
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .gameGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .gameQ{
      padding: 12px;
      border: 1px solid #e3e7f2;
      border-radius: 12px;
      background: #f7f9fe;
    }
    .choices label{
      display:block;
      font-weight: 500;
      margin-top: 8px;
    }
    .smallBtn{
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 8px;
    }

    .scorePill{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.22);
      color: #ffffff;
      font-weight: 700;
      font-size: 0.9rem;
      margin-top: 10px;
    }

    .gifBox{
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e3e7f2;
      background: #f7f9fe;
      margin-top: 12px;
    }
    .gifBox img{
      width: 100%;
      height: auto;
      display: block;
      margin: 0;
      border-radius: 0;
    }
  </style>
</head>

<body>

<header>
  <h1>üöÄ To Infinity and Beyond</h1>
  <p><span class="pill">Key question</span> Space conquest: a way to make money, a competition or a necessity?</p>
  <p><span class="pill">Theme</span> Space conquest: scientific innovations and responsibility</p>
  <div class="scorePill" id="scorePill">Score: 0</div>
</header>

<main>
  <div class="nav">
    <button type="button" onclick="showPage('worksheet')">Lesson 1 ‚Äì Worksheet (start here)</button>
    <button type="button" onclick="showLesson2()">Lesson 2 ‚Äì Video (locked)</button>
    <button type="button" onclick="showPage('vocab2')" id="btnVocab2" style="display:none;">Video Vocabulary</button>
    <button type="button" onclick="showPage('vocab')" id="btnVocab" style="display:none;">Vocabulary game</button>
    <button type="button" class="smallBtn" onclick="resetAll()">Reset / Restart</button>
  </div>

  <!-- PAGE: WORKSHEET -->
  <section id="page-worksheet">
    <div class="card">
      <h2>Before you start</h2>
      <p>Use the following resource to find relevant information before answering the questions:</p>
      <p>
        <a href="https://www.spacefoundation.org/space_brief/us-space-law/" target="_blank" rel="noopener noreferrer">
          https://www.spacefoundation.org/space_brief/us-space-law/
        </a>
      </p>
      <p class="hint">Tip: focus on key ideas about the role of the government, private companies, and resource rights.</p>
    </div>

    <div class="card">
      <h2>Lesson 1 ‚Äì Asteroid Mining (Worksheet)</h2>
      <p class="hint">
        <strong>How it works:</strong> Answer <strong>one question at a time</strong>.
        Minimum: <strong>15 words</strong>. No maximum.
      </p>

      <div class="figure">
        <img src="images/asteroid-infographic.jpeg" alt="Asteroid mining infographic" />
        <div class="caption">Study this infographic carefully before answering questions 1 and 2.</div>

        <!-- Step 1 -->
        <div class="step active" id="step-q1">
          <div class="stepHeader">
            <div><span class="badge">Question 1/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>1. Why are the 1958 Space Act and the 2015 Space Act both relevant today?</label>
          <textarea id="q1" rows="5" placeholder="Write in full sentences..."></textarea>
          <div class="counter" id="c_q1">Words: 0/15</div>

          <button type="button" onclick="submitOne('q1')">Submit Q1</button>
          <button type="button" class="smallBtn" id="next_q1" onclick="goNext('q1')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_q1"></div>

          <div class="answers" id="ans_q1">
            <h3>Correction (Q1)</h3>
            <p>The 1958 Space Act set up a public framework for U.S. space activities, while the 2015 U.S. Commercial Space Launch Competitiveness Act supports commercial involvement and resource rights. Together, they shape today‚Äôs debate about space as a public mission and a commercial opportunity.</p>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="step" id="step-q2">
          <div class="stepHeader">
            <div><span class="badge">Question 2/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>2. Explain the different steps of the process shown in the infographic.</label>
          <textarea id="q2" rows="5" placeholder="Describe the steps clearly..."></textarea>
          <div class="counter" id="c_q2">Words: 0/15</div>

          <button type="button" onclick="submitOne('q2')">Submit Q2</button>
          <button type="button" class="smallBtn" id="next_q2" onclick="goNext('q2')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_q2"></div>

          <div class="answers" id="ans_q2">
            <h3>Correction (Q2)</h3>
            <p>Possible steps: launch a spacecraft ‚Üí locate/approach an asteroid ‚Üí analyze composition ‚Üí confirm valuable resources (e.g., water) ‚Üí extract/collect materials ‚Üí use them in space or send information/resources back.</p>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="step" id="step-q3">
          <div class="stepHeader">
            <div><span class="badge">Question 3/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>3. Why is water important in space?</label>
          <textarea id="q3" rows="4" placeholder="Use at least two reasons..."></textarea>
          <div class="counter" id="c_q3">Words: 0/15</div>

          <button type="button" onclick="submitOne('q3')">Submit Q3</button>
          <button type="button" class="smallBtn" id="next_q3" onclick="goNext('q3')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_q3"></div>

          <div class="answers" id="ans_q3">
            <h3>Correction (Q3)</h3>
            <p>Water is essential for life support (drinking, oxygen) and it can be processed to make rocket propellant, enabling longer missions and refuelling in space.</p>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="step" id="step-q4">
          <div class="stepHeader">
            <div><span class="badge">Question 4/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>4. Does the document support or oppose asteroid mining? Why?</label>
          <textarea id="q4" rows="5" placeholder="State a position and justify with evidence..."></textarea>
          <div class="counter" id="c_q4">Words: 0/15</div>

          <button type="button" onclick="submitOne('q4')">Submit Q4</button>
          <button type="button" class="smallBtn" id="next_q4" onclick="goNext('q4')" style="display:none; margin-left:10px;">Finish</button>

          <div class="feedback" id="fb_q4"></div>

          <div class="answers" id="ans_q4">
            <h3>Correction (Q4)</h3>
            <p>Many such documents are generally supportive/optimistic because they highlight feasibility and benefits (especially water). A critical reading can also note what is missing (risks, ethics, environment). Any position is acceptable if justified with evidence from the document.</p>
          </div>
        </div>

        <!-- End message -->
        <div class="card" id="lesson1DoneCard" style="display:none;">
          <h2>Lesson 1 completed ‚úÖ</h2>
          <p><strong>Write that in your copybook.</strong></p>

          <h3>Summary / Course</h3>
          <p id="courseSummary" class="hint" style="opacity:1; color:#000;"></p>

          <p class="hint">Lesson 2 is locked with a code. If you finish early, use the vocabulary games.</p>
          <div class="row">
            <button type="button" class="smallBtn" onclick="showPage('vocab2')">Video Vocabulary</button>
            <button type="button" class="smallBtn" onclick="showPage('vocab')">Vocabulary game</button>
            <button type="button" class="smallBtn" onclick="showLesson2()">Unlock Lesson 2</button>
            <button type="button" class="smallBtn" onclick="resetAll()">Reset / Restart</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- PAGE: VIDEO -->
  <section id="page-video" style="display:none;">
    <div class="card">
      <h2>Lesson 2 ‚Äì Video: Asteroid Mining</h2>
      <p class="hint"><strong>This is Lesson 2.</strong> Work question by question. Minimum: <strong>15 words</strong> (no maximum). Use facts from the video (numbers, types, methods).</p>

      <div style="position:relative; padding-top:56.25%; border-radius:12px; overflow:hidden;">
        <iframe
          src="https://www.youtube.com/embed/erF17yO9VsE"
          title="Asteroid Mining (YouTube)"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
          style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;">
        </iframe>
      </div>

      <div class="card" style="margin-top:14px;">
        <h3>Activities (Lesson 2)</h3>

        <!-- L2 Step 1 -->
        <div class="step active" id="step-v1">
          <div class="stepHeader">
            <div><span class="badge">Activity 1/6</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>A1. In 2‚Äì3 sentences, explain what asteroids are and where most of them are located.</label>
          <textarea id="v1" rows="3" placeholder="Write your answer..."></textarea>
          <div class="counter" id="c_v1">Words: 0/15</div>

          <button type="button" onclick="submitOne('v1')">Submit A1</button>
          <button type="button" class="smallBtn" id="next_v1" onclick="goNextLesson2('v1')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_v1"></div>
          <div class="answers" id="ans_v1">
            <h3>Correction (A1)</h3>
            <p>Asteroids (minor planets / planetoids) are pieces of space debris left over from planet formation. Most are located in the main asteroid belt between Mars and Jupiter.</p>
          </div>
        </div>

        <!-- L2 Step 2 -->
        <div class="step" id="step-v2">
          <div class="stepHeader">
            <div><span class="badge">Activity 2/6</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>A2. Give two numbers from the video and explain what they refer to (full sentences).</label>
          <textarea id="v2" rows="3" placeholder="Example: 'The video says..., which means...'"></textarea>
          <div class="counter" id="c_v2">Words: 0/15</div>

          <button type="button" onclick="submitOne('v2')">Submit A2</button>
          <button type="button" class="smallBtn" id="next_v2" onclick="goNextLesson2('v2')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_v2"></div>
          <div class="answers" id="ans_v2">
            <h3>Correction (A2)</h3>
            <p>Any two correct facts, for example: the main belt contains about 750,000 asteroids over 1 km across; over 200 exceed 100 km in diameter; near-Earth groups contain about 9,000 asteroids; around 1,500 near-Earth asteroids are candidates for mining.</p>
          </div>
        </div>

        <!-- L2 Step 3 -->
        <div class="step" id="step-v3">
          <div class="stepHeader">
            <div><span class="badge">Activity 3/6</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>A3. Compare C-type, S-type and M-type asteroids: what are they made of, and what can they contain?</label>
          <textarea id="v3" rows="4" placeholder="Write your answer..."></textarea>
          <div class="counter" id="c_v3">Words: 0/15</div>

          <button type="button" onclick="submitOne('v3')">Submit A3</button>
          <button type="button" class="smallBtn" id="next_v3" onclick="goNextLesson2('v3')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_v3"></div>
          <div class="answers" id="ans_v3">
            <h3>Correction (A3)</h3>
            <p>C-type (carbonaceous) can contain carbon compounds, rock and water (up to about 20%). S-type (silicious) contains silicates (iron/magnesium) and some metals. M-type (metallic) is mainly nickel and iron, sometimes with platinum-group deposits.</p>
          </div>
        </div>

        <!-- L2 Step 4 -->
        <div class="step" id="step-v4">
          <div class="stepHeader">
            <div><span class="badge">Activity 4/6</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>A4. Explain why water can be as valuable as metals in space (give at least two reasons).</label>
          <textarea id="v4" rows="3" placeholder="Write your answer..."></textarea>
          <div class="counter" id="c_v4">Words: 0/15</div>

          <button type="button" onclick="submitOne('v4')">Submit A4</button>
          <button type="button" class="smallBtn" id="next_v4" onclick="goNextLesson2('v4')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_v4"></div>
          <div class="answers" id="ans_v4">
            <h3>Correction (A4)</h3>
            <p>Water is critical in space for life support (humans need it), and it can provide oxygen and be used to make rocket fuel/propellant, helping refuelling and longer missions.</p>
          </div>
        </div>

        <!-- L2 Step 5 -->
        <div class="step" id="step-v5">
          <div class="stepHeader">
            <div><span class="badge">Activity 5/6</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>A5. Describe two mining approaches mentioned in the video. Explain briefly how they work.</label>
          <textarea id="v5" rows="4" placeholder="Write your answer..."></textarea>
          <div class="counter" id="c_v5">Words: 0/15</div>

          <button type="button" onclick="submitOne('v5')">Submit A5</button>
          <button type="button" class="smallBtn" id="next_v5" onclick="goNextLesson2('v5')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_v5"></div>
          <div class="answers" id="ans_v5">
            <h3>Correction (A5)</h3>
            <p>Examples: (1) Bases on large asteroids with quarters cut into rock for radiation shielding and surface facilities to process materials. (2) Limpet ships that attach (often robotic), dig into the surface, and store extracted materials. (3) Processing stations fed by small asteroids/laser-cut sections. (4) Rocket trains transporting captured sections to processing stations.</p>
          </div>
        </div>

        <!-- L2 Step 6 -->
        <div class="step" id="step-v6">
          <div class="stepHeader">
            <div><span class="badge">Activity 6/6</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words</div>
          </div>

          <label>A6. In your opinion, why might asteroid mining become necessary in the future even if it is not profitable today? Use two ideas from the video.</label>
          <textarea id="v6" rows="4" placeholder="Write your opinion + two facts from the video..."></textarea>
          <div class="counter" id="c_v6">Words: 0/15</div>

          <button type="button" onclick="submitOne('v6')">Submit A6</button>
          <button type="button" class="smallBtn" id="next_v6" onclick="goNextLesson2('v6')" style="display:none; margin-left:10px;">Finish</button>

          <div class="feedback" id="fb_v6"></div>
          <div class="answers" id="ans_v6">
            <h3>Correction (A6)</h3>
            <p>Possible ideas: it is not profitable yet, but resource demand may triple by 2050 and Earth has finite supplies; space resources could help future missions; mining could reduce some environmental impacts; low gravity can make extraction/transport easier.</p>
          </div>
        </div>

        <!-- End Lesson 2 -->
        <div class="card" id="lesson2DoneCard" style="display:none; margin-top:14px;">
          <h2>Lesson 2 completed ‚úÖ</h2>
          <p><strong>Final score:</strong> <span id="finalScoreText"></span></p>

          <h3>Summary / Trace √©crite (copy in your notebook)</h3>
          <p class="hint" id="lesson2Course" style="opacity:1; color:#000;"></p>

          <p class="hint" id="finalFeedback" style="opacity:1; color:#000;"></p>

          <div class="gifBox">
            <img id="congratsGif" alt="Congratulations GIF" />
          </div>

          <div class="row">
            <button type="button" class="smallBtn" onclick="showPage('worksheet')">Back to Lesson 1</button>
            <button type="button" class="smallBtn" onclick="showPage('vocab2')">Video Vocabulary</button>
            <button type="button" class="smallBtn" onclick="showPage('vocab')">Vocabulary game</button>
            <button type="button" class="smallBtn" onclick="resetAll()">Reset / Restart</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- PAGE: VIDEO VOCAB GAME -->
  <section id="page-vocab2" style="display:none;">
    <div class="card">
      <h2>Video Vocabulary (Lesson 2)</h2>
      <p class="hint">Choose the best definition. Try to get 8/10 or more.</p>

      <div class="gameGrid" id="videoGameGrid"></div>

      <div class="row">
        <button type="button" class="smallBtn" onclick="gradeVideoGame()">Check my score</button>
        <button type="button" class="smallBtn" onclick="newVideoGame()">New round</button>
        <button type="button" class="smallBtn" onclick="showPage('video')">Back to Lesson 2</button>
      </div>

      <div class="feedback" id="fb_videogame"></div>
    </div>
  </section>

  <!-- PAGE: VOCAB GAME (GENERAL) -->
  <section id="page-vocab" style="display:none;">
    <div class="card">
      <h2>Vocabulary game (when you finish early)</h2>
      <p class="hint">Do this quietly while waiting for correction. Try to get 6/6.</p>

      <div class="gameGrid" id="gameGrid"></div>

      <div class="row">
        <button type="button" class="smallBtn" onclick="gradeGame()">Check my score</button>
        <button type="button" class="smallBtn" onclick="newGame()">New round</button>
        <button type="button" class="smallBtn" onclick="showPage('worksheet')">Back to Lesson 1</button>
      </div>

      <div class="feedback" id="fb_game"></div>
    </div>
  </section>

</main>

<!-- Lesson 2 code modal -->
<div class="modalBackdrop" id="codeModal">
  <div class="modal">
    <h2>Unlock Lesson 2</h2>
    <p>Enter the code given by your teacher.</p>
    <input id="codeInput" type="password" placeholder="Enter code‚Ä¶" autocomplete="off" />
    <div class="row">
      <button type="button" onclick="tryUnlock()">Unlock</button>
      <button type="button" onclick="closeModal()">Cancel</button>
    </div>
    <div class="feedback" id="fb_code" style="display:none;"></div>
  </div>
</div>

<script>
  /* ============================================================
     CONFIG
  ============================================================ */
  const LESSON2_CODE = "misterbruno";
  const MIN_WORDS = 15;

  // === AI (via Cloudflare Worker) ===
  const WORKER_URL = "https://toinfinityandbeyond.tristanbrunoedu.workers.dev";
  const USE_AI_VALIDATION = true;

  // External GIF
  const CONGRATS_GIF_URL = "https://media.giphy.com/media/111ebonMs90YLu/giphy.gif";

  // Scoring
  const POINTS_ACCEPTED = 2;
  const POINTS_INCOMPLETE = 1;

  // Storage
  const STORE_PREFIX = "tiab_v2_";

  // Step order
  const stepOrderL1 = ["q1","q2","q3","q4"];
  const stepOrderL2 = ["v1","v2","v3","v4","v5","v6"];

  const TEXT_FIELDS = ["q1","q2","q3","q4","v1","v2","v3","v4","v5","v6"];

  /* ============================================================
     NAV + LESSON 2 LOCK
  ============================================================ */
  function showPage(which){
    const pages = ["worksheet","video","vocab","vocab2"];
    pages.forEach(p => {
      const el = document.getElementById("page-" + p);
      if (el) el.style.display = (p === which ? "block" : "none");
    });
    window.scrollTo({top: 0, behavior: "smooth"});
  }

  function openModal(){
    document.getElementById("codeModal").classList.add("show");
    const fb = document.getElementById("fb_code");
    fb.style.display = "none";
    fb.textContent = "";
    document.getElementById("codeInput").value = "";
    document.getElementById("codeInput").focus();
  }

  function closeModal(){
    document.getElementById("codeModal").classList.remove("show");
  }

  function lesson2Unlocked(){
    try { return sessionStorage.getItem(STORE_PREFIX + "lesson2Unlocked") === "1"; }
    catch(e){ return false; }
  }

  function markLesson2Unlocked(){
    try { sessionStorage.setItem(STORE_PREFIX + "lesson2Unlocked","1"); } catch(e){}
  }

  function showLesson2(){
    if (!lesson2Unlocked()){
      openModal();
      return;
    }
    showPage("video");
  }

  function tryUnlock(){
    const v = (document.getElementById("codeInput").value || "").trim().toLowerCase();
    const fb = document.getElementById("fb_code");
    fb.style.display = "block";

    if (v === LESSON2_CODE){
      fb.textContent = "Unlocked ‚úÖ";
      markLesson2Unlocked();
      setTimeout(() => {
        closeModal();
        showPage("video");
      }, 350);
    } else {
      fb.textContent = "Wrong code. Try again.";
    }
  }

  /* ============================================================
     RESET / RESTART
  ============================================================ */
  function resetAll(){
    const ok = confirm("Reset everything (answers, score, progress) and restart?");
    if (!ok) return;

    try{
      // localStorage keys
      const keys = [];
      for (let i = 0; i < localStorage.length; i++){
        const k = localStorage.key(i);
        if (k && k.startsWith(STORE_PREFIX)) keys.push(k);
      }
      keys.forEach(k => localStorage.removeItem(k));
    } catch(e){}

    try{
      // session storage keys
      const keys = [];
      for (let i = 0; i < sessionStorage.length; i++){
        const k = sessionStorage.key(i);
        if (k && k.startsWith(STORE_PREFIX)) keys.push(k);
      }
      keys.forEach(k => sessionStorage.removeItem(k));
    } catch(e){}

    location.reload();
  }

  /* ============================================================
     STORAGE HELPERS
  ============================================================ */
  function k(key){ return STORE_PREFIX + key; }

  function storeSet(key, value){
    try { localStorage.setItem(k(key), value); } catch(e){}
  }
  function storeGet(key, fallback=""){
    try {
      const v = localStorage.getItem(k(key));
      return (v === null || v === undefined) ? fallback : v;
    } catch(e){ return fallback; }
  }
  function storeSetJSON(key, obj){
    try { localStorage.setItem(k(key), JSON.stringify(obj)); } catch(e){}
  }
  function storeGetJSON(key, fallback=null){
    try {
      const raw = localStorage.getItem(k(key));
      if (!raw) return fallback;
      return JSON.parse(raw);
    } catch(e){ return fallback; }
  }

  function statusKey(fieldId){ return "status_" + fieldId; }
  function answerKey(fieldId){ return "answer_" + fieldId; }

  function setStatus(fieldId, obj){
    storeSetJSON(statusKey(fieldId), obj);
    updateScoreUI();
  }
  function getStatus(fieldId){
    return storeGetJSON(statusKey(fieldId), null);
  }

  function setAnswer(fieldId, value){
    storeSet(answerKey(fieldId), value);
  }
  function getAnswer(fieldId){
    return storeGet(answerKey(fieldId), "");
  }

  /* ============================================================
     STEP CONTROL
  ============================================================ */
  function setActiveStepL1(id){
    stepOrderL1.forEach(q => {
      const box = document.getElementById("step-" + q);
      if (box) box.classList.toggle("active", q === id);
    });
    storeSet("activeStepL1", id);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function setActiveStepL2(id){
    stepOrderL2.forEach(q => {
      const box = document.getElementById("step-" + q);
      if (box) box.classList.toggle("active", q === id);
    });
    storeSet("activeStepL2", id);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function unlockVocabButtons(){
    const b1 = document.getElementById("btnVocab");
    const b2 = document.getElementById("btnVocab2");
    if (b1) b1.style.display = "inline-block";
    if (b2) b2.style.display = "inline-block";
  }

  function showCorrection(fieldId, show){
    const ans = document.getElementById("ans_" + fieldId);
    if (ans) ans.style.display = show ? "block" : "none";
  }

  function showNextButton(fieldId){
    const btn = document.getElementById("next_" + fieldId);
    if (btn) btn.style.display = "inline-block";
  }

  function hideNextButton(fieldId){
    const btn = document.getElementById("next_" + fieldId);
    if (btn) btn.style.display = "none";
  }

  function goNext(fieldId){
    const idx = stepOrderL1.indexOf(fieldId);
    if (idx >= 0 && idx < stepOrderL1.length - 1){
      setActiveStepL1(stepOrderL1[idx+1]);
      return;
    }
    finishLesson1();
  }

  function goNextLesson2(fieldId){
    const idx = stepOrderL2.indexOf(fieldId);
    if (idx >= 0 && idx < stepOrderL2.length - 1){
      setActiveStepL2(stepOrderL2[idx+1]);
      return;
    }
    finishLesson2();
  }

  /* ============================================================
     AI VALIDATION (Cloudflare Worker)
  ============================================================ */
  function getQuestionText(fieldId){
    const step = document.getElementById("step-" + fieldId);
    if (!step) return "";
    const lab = step.querySelector("label");
    return lab ? lab.textContent.trim() : "";
  }

  function getReferenceAnswerText(fieldId){
    const ans = document.getElementById("ans_" + fieldId);
    if (!ans) return "";
    return ans.textContent.replace(/\s+/g, " ").trim();
  }

  async function callAIValidator({ question, referenceAnswer, studentAnswer, minWords }){
    const payload = { question, referenceAnswer, studentAnswer, minWords };

    const r = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await r.json().catch(() => null);
    if (!r.ok) {
      const details = data && (data.details || data.error) ? (data.details || data.error) : ("HTTP " + r.status);
      throw new Error(details);
    }
    return data;
  }

  function pointsFromAIStatus(aiStatus){
    if (aiStatus === "ACCEPTED") return POINTS_ACCEPTED;
    if (aiStatus === "INCOMPLETE") return POINTS_INCOMPLETE;
    return 0; // REWORK
  }

  function formatAIFeedback(result){
    let txt = result && result.feedback ? String(result.feedback) : "";

    if (result && Array.isArray(result.missingIdeas) && result.missingIdeas.length > 0){
      txt += "\n\nMissing key ideas:\n";
      for (const idea of result.missingIdeas.slice(0, 6)){
        txt += "‚Ä¢ " + idea + "\n";
      }
    }
    if (result && result.status === "REWORK"){
      txt += (txt ? "\n\n" : "") + "Please rewrite in clear full sentences (on topic).";
    }
    return txt.trim();
  }

  function disableStepButtons(fieldId, disabled){
    const step = document.getElementById("step-" + fieldId);
    if (!step) return;
    step.querySelectorAll("button").forEach(b => { b.disabled = disabled; });
  }

  /* ============================================================
     LOCAL FILTERS (anti-charabia + min words)
     (Used before AI call to save tokens)
  ============================================================ */
  const STOP = new Set([
    "the","a","an","and","or","but","so","because","since","therefore","thus",
    "to","of","in","on","at","for","from","with","as","by","into","about",
    "is","are","was","were","be","been","being","it","this","that","these","those",
    "they","we","you","i","he","she","them","us","our","their","your","my"
  ]);

  function stripDiacritics(s){
    return (s || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  function normalizeText(s){
    let t = stripDiacritics(String(s || "").toLowerCase()).trim();
    t = t
      .replace(/\bcan't\b/g, "cannot")
      .replace(/\bdon't\b/g, "do not")
      .replace(/\bdoesn't\b/g, "does not")
      .replace(/\bdidn't\b/g, "did not")
      .replace(/\bwon't\b/g, "will not")
      .replace(/\bi'm\b/g, "i am")
      .replace(/\bit's\b/g, "it is")
      .replace(/\bthat's\b/g, "that is");

    t = t.replace(/[^a-z0-9'\s]+/g, " ").replace(/\s+/g, " ").trim();
    return t;
  }

  function tokens(text, { removeStop=true } = {}){
    const t = normalizeText(text);
    if (!t) return [];
    const raw = t.split(" ").filter(Boolean);
    if (!removeStop) return raw;

    return raw
      .map(w => {
        if (w.length > 5 && w.endsWith("ing")) return w.slice(0, -3);
        if (w.length > 4 && w.endsWith("ed"))  return w.slice(0, -2);
        if (w.length > 4 && w.endsWith("s"))   return w.slice(0, -1);
        return w;
      })
      .filter(w => !STOP.has(w));
  }

  function wordsCount(text){
    const t = normalizeText(text);
    if (!t) return 0;
    return t.split(/\s+/).filter(Boolean).length;
  }

  function uniqueRatio(wordList){
    const s = new Set(wordList);
    return s.size / Math.max(1, wordList.length);
  }

  function isSpam(text){
    const raw = (text || "").trim();
    if (raw.length < 10) return true;

    const compact = raw.toLowerCase().replace(/[\s\W_]+/g, "");
    if (compact.length < 10) return true;

    // repeated char run
    let run = 1;
    for (let i = 1; i < compact.length; i++) {
      if (compact[i] === compact[i - 1]) {
        run++;
        if (run >= 10) return true;
      } else run = 1;
    }

    // ababab pattern
    if (compact.length >= 24) {
      const a = compact[0], b = compact[1];
      if (a && b) {
        let ok = true;
        for (let i = 0; i < compact.length; i++) {
          if (compact[i] !== (i % 2 === 0 ? a : b)) { ok = false; break; }
        }
        if (ok) return true;
      }
    }

    // repeated same word too much
    const w = tokens(raw, { removeStop:false });
    if (w.length >= 12) {
      const counts = new Map();
      for (const x of w) {
        const clean = x.replace(/[^a-z0-9']/g, "");
        if (clean.length <= 2) continue;
        counts.set(clean, (counts.get(clean) || 0) + 1);
      }
      let max = 0;
      for (const v of counts.values()) max = Math.max(max, v);
      const ratio = max / Math.max(1, w.length);
      if (raw.length < 160 && ratio > 0.45) return true;
      if (raw.length >= 160 && ratio > 0.32) return true;
    }

    // keyword-list detector (short answers)
    const wc = wordsCount(raw);
    if (wc <= 35) {
      const nt = normalizeText(raw);
      const hasConnector = /(\bbecause\b|\bsince\b|\bso\b|\btherefore\b|\bbut\b)/.test(nt);
      const hasVerbish = /(\bis\b|\bare\b|\bwas\b|\bwere\b|\bcan\b|\bcould\b|\bshould\b|\bwill\b)/.test(nt);
      const hasPunct = /[.!?;]/.test(raw);
      const ur = uniqueRatio(tokens(raw, { removeStop:true }));
      if (!hasConnector && !hasVerbish && !hasPunct && ur > 0.75 && wc >= 15) return true;
    }

    return false;
  }

  function passesGate(fieldId, value){
    const v = (value || "").trim();
    const wc = wordsCount(v);

    if (isSpam(v)){
      return { ok:false, msg:"‚ùå Not yet. Your answer is not readable enough (too repetitive / list-like). Write full sentences." };
    }
    if (wc < MIN_WORDS){
      return { ok:false, msg:`‚ùå Not yet. Please write at least ${MIN_WORDS} words (no maximum).` };
    }
    return { ok:true, msg:"" };
  }

  /* ============================================================
     COUNTERS
  ============================================================ */
  const counterMap = [
    { id:"q1", counter:"c_q1" },
    { id:"q2", counter:"c_q2" },
    { id:"q3", counter:"c_q3" },
    { id:"q4", counter:"c_q4" },
    { id:"v1", counter:"c_v1" },
    { id:"v2", counter:"c_v2" },
    { id:"v3", counter:"c_v3" },
    { id:"v4", counter:"c_v4" },
    { id:"v5", counter:"c_v5" },
    { id:"v6", counter:"c_v6" }
  ];

  function updateCounter(fieldId){
    const cfg = counterMap.find(x=>x.id===fieldId);
    if(!cfg) return;
    const el = document.getElementById(cfg.id);
    const c  = document.getElementById(cfg.counter);
    if(!el||!c) return;

    const wc = wordsCount(el.value);
    c.textContent = `Words: ${wc}/${MIN_WORDS}`;
    c.classList.remove("bad","good");

    if (el.value.trim().length===0) return;
    if (isSpam(el.value) || wc < MIN_WORDS) c.classList.add("bad");
    else c.classList.add("good");
  }

  function attachCounters(){
    counterMap.forEach(cfg=>{
      const el = document.getElementById(cfg.id);
      if(!el) return;
      el.addEventListener("input", ()=>{
        updateCounter(cfg.id);
        setAnswer(cfg.id, el.value);
      });
      el.addEventListener("blur", ()=>{
        updateCounter(cfg.id);
        setAnswer(cfg.id, el.value);
      });
      updateCounter(cfg.id);
    });
  }

  /* ============================================================
     SUBMIT (AI + graceful fallback)
  ============================================================ */
  async function submitOne(fieldId){
    const el = document.getElementById(fieldId);
    const fb = document.getElementById("fb_" + fieldId);
    if (!el || !fb) return;

    const value = el.value.trim();
    setAnswer(fieldId, el.value);

    fb.style.display = "block";
    showCorrection(fieldId, false);
    hideNextButton(fieldId);

    // Local gate first
    const gate = passesGate(fieldId, value);
    if (!gate.ok){
      fb.textContent = gate.msg;
      return;
    }

    // AI mode
    if (USE_AI_VALIDATION){
      disableStepButtons(fieldId, true);
      fb.textContent = "Checking your answer‚Ä¶";

      try {
        const question = getQuestionText(fieldId);
        const referenceAnswer = getReferenceAnswerText(fieldId);

        const result = await callAIValidator({
          question,
          referenceAnswer,
          studentAnswer: value,
          minWords: MIN_WORDS
        });

        const pts = pointsFromAIStatus(result.status);
        fb.textContent = formatAIFeedback(result);

        const showCorr = (result.status !== "ACCEPTED");
        showCorrection(fieldId, showCorr);

        if (result.allowNext) showNextButton(fieldId);
        else hideNextButton(fieldId);

        const level =
          result.status === "ACCEPTED" ? "accepted" :
          result.status === "INCOMPLETE" ? "incomplete" : "rework";

        setStatus(fieldId, { submitted:true, level, points: pts, ts: Date.now(), ai: result });

        unlockVocabButtons();

        if (stepOrderL1.every(id => (getStatus(id)||{}).submitted)) finishLesson1(true);
        if (stepOrderL2.every(id => (getStatus(id)||{}).submitted)) finishLesson2(true);

      } catch (e) {
        // Do not block students if AI fails
        fb.textContent = "Service issue. Your answer is saved. You can click Next.";
        showCorrection(fieldId, false);
        showNextButton(fieldId);
        setStatus(fieldId, { submitted:true, level:"incomplete", points: POINTS_INCOMPLETE, ts: Date.now(), aiError: String(e?.message || e) });
        unlockVocabButtons();
      } finally {
        disableStepButtons(fieldId, false);
      }
      return;
    }

    // If AI off: simple accept (still uses gate)
    fb.textContent = "‚úÖ Submitted. You can click Next.";
    showNextButton(fieldId);
    setStatus(fieldId, { submitted:true, level:"accepted", points: POINTS_ACCEPTED, ts: Date.now() });
    unlockVocabButtons();
  }

  /* ============================================================
     FINISH
  ============================================================ */
  function finishLesson1(silent=false){
    storeSet("lesson1Done","1");
    document.getElementById("lesson1DoneCard").style.display = "block";

    const summary =
      "The 1958 Space Act created a public framework for U.S. space activities, while the 2015 act supports private companies and resource rights. " +
      "Asteroid mining involves locating an asteroid, analysing its composition, extracting resources (especially water), and using them in space. " +
      "Water supports life and can be turned into propellant, enabling longer missions. " +
      "A justified opinion should use evidence and mention possible benefits and limits.";
    const p = document.getElementById("courseSummary");
    if (p) p.textContent = summary;

    unlockVocabButtons();
    updateScoreUI();

    if (!silent) window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  function finishLesson2(silent=false){
    storeSet("lesson2Done","1");

    const card = document.getElementById("lesson2DoneCard");
    card.style.display = "block";

    const total = getTotalScore();
    const max = getMaxScore();

    document.getElementById("finalScoreText").textContent = `${total} / ${max}`;

    // Short trace √©crite (adapt√©e, cahier-ready)
    const course =
      "Asteroids are leftover space debris; most are in the main asteroid belt between Mars and Jupiter. " +
      "They can be C-type (often with water), S-type (silicates), or M-type (metal-rich). " +
      "In space, water is crucial for life support and for making oxygen/rocket fuel. " +
      "Mining could use bases, robotic ‚Äúlimpet ships‚Äù, and processing stations, even if it is not profitable yet.";
    const p = document.getElementById("lesson2Course");
    if (p) p.textContent = course;

    const pct = max > 0 ? (total / max) : 0;
    let msg = "Well done. Add more precise facts from the video (numbers, types, methods).";
    if (pct >= 0.85) msg = "Excellent work. Your answers are precise and well supported.";
    else if (pct >= 0.65) msg = "Good work. Improve precision by adding more facts from the video.";
    else if (pct >= 0.45) msg = "Good effort. Read corrections and reuse key vocabulary from the video.";
    else msg = "Keep going. Use corrections and add facts (numbers and key terms) in your answers.";

    document.getElementById("finalFeedback").textContent = msg;
    document.getElementById("congratsGif").src = CONGRATS_GIF_URL;

    unlockVocabButtons();
    updateScoreUI();

    if (!silent) window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  /* ============================================================
     SCORE
  ============================================================ */
  function getMaxScore(){
    // Lesson 1: 4 items, Lesson 2: 6 items => 10 * 2
    return (4 + 6) * 2;
  }

  function getTotalScore(){
    let sum = 0;
    const all = [...stepOrderL1, ...stepOrderL2];
    for (const id of all){
      const st = getStatus(id);
      if (st && st.submitted) sum += Number(st.points || 0);
    }
    return sum;
  }

  function updateScoreUI(){
    const pill = document.getElementById("scorePill");
    if (!pill) return;
    pill.textContent = `Score: ${getTotalScore()} / ${getMaxScore()}`;
  }

  /* ============================================================
     RESTORE
  ============================================================ */
  function restoreAnswers(){
    for (const id of TEXT_FIELDS){
      const el = document.getElementById(id);
      if (!el) continue;
      const v = getAnswer(id);
      if (v) el.value = v;
      updateCounter(id);
    }

    const all = [...stepOrderL1, ...stepOrderL2];
    for (const id of all){
      const st = getStatus(id);
      if (!st || !st.submitted) continue;

      const fb = document.getElementById("fb_" + id);
      if (fb){
        fb.style.display = "block";
        if (st.ai && typeof st.ai === "object") fb.textContent = formatAIFeedback(st.ai);
        else fb.textContent = "‚úÖ Already submitted. You can click Next.";
      }

      showCorrection(id, st.level !== "accepted");
      showNextButton(id);
    }

    const activeL1 = storeGet("activeStepL1", "q1");
    const activeL2 = storeGet("activeStepL2", "v1");
    if (stepOrderL1.includes(activeL1)) setActiveStepL1(activeL1);
    if (stepOrderL2.includes(activeL2)) setActiveStepL2(activeL2);

    const l1done = storeGet("lesson1Done","0") === "1";
    if (l1done) finishLesson1(true);

    const l2done = storeGet("lesson2Done","0") === "1";
    if (l2done) finishLesson2(true);

    const anySubmitted = [...stepOrderL1, ...stepOrderL2].some(id => (getStatus(id)||{}).submitted);
    if (anySubmitted) unlockVocabButtons();

    updateScoreUI();
  }

  /* ============================================================
     VOCAB GAME (GENERAL)
  ============================================================ */
  const vocabItems = [
    { term:"to extract", def:"to remove (a material) from something" },
    { term:"resources", def:"useful materials that can be used or sold" },
    { term:"to refuel", def:"to fill a vehicle with fuel again" },
    { term:"propellant", def:"substance used to move a rocket forward" },
    { term:"life support", def:"systems that keep humans alive (air/water/etc.)" },
    { term:"to launch", def:"to send a rocket/spacecraft into space" }
  ];

  function shuffle(arr){
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function pickDistractors(correctDef, allDefs, n=3){
    const pool = allDefs.filter(d => d !== correctDef);
    const chosen = [];
    const used = new Set();
    for (const d of pool){
      if (!used.has(d)) used.add(d);
    }
    const uniqPool = Array.from(used);
    const shuffled = shuffle(uniqPool);
    for (const d of shuffled){
      if (chosen.length >= n) break;
      chosen.push(d);
    }
    return chosen;
  }

  function newGame(){
    const grid = document.getElementById("gameGrid");
    const fb = document.getElementById("fb_game");
    fb.style.display = "none";
    fb.textContent = "";
    grid.innerHTML = "";

    const terms = shuffle(vocabItems);
    const allDefs = vocabItems.map(x=>x.def);

    terms.forEach((item, idx)=>{
      const qId = "vg_" + idx;
      const correct = item.def;

      const distractors = pickDistractors(correct, allDefs, 3);
      const options = shuffle([correct, ...distractors]);

      const box = document.createElement("div");
      box.className = "gameQ";
      box.innerHTML = `
        <div class="stepHeader">
          <div><span class="badge">Vocab ${idx+1}/6</span></div>
          <div class="hint" style="margin:0;">Choose the correct definition</div>
        </div>
        <div style="font-weight:800; color:#1f3a5f; font-size:1.05rem;">${escapeHtml(item.term)}</div>
        <div class="choices" style="margin-top:8px;">
          ${options.map((c)=>`
            <label>
              <input type="radio" name="${qId}" value="${escapeHtml(c)}">
              ${escapeHtml(c)}
            </label>
          `).join("")}
        </div>
        <input type="hidden" id="${qId}_ans" value="${escapeHtml(correct)}">
      `;
      grid.appendChild(box);
    });
  }

  function gradeGame(){
    const fb = document.getElementById("fb_game");
    let score = 0;

    for (let i=0;i<6;i++){
      const qId = "vg_" + i;
      const correct = (document.getElementById(qId+"_ans").value || "");
      const pickedEl = document.querySelector(`input[name="${qId}"]:checked`);
      const picked = pickedEl ? pickedEl.value : "";
      if (picked && picked === correct) score++;
    }

    fb.style.display = "block";
    fb.textContent = `Score: ${score}/6. ${score>=5 ? "Great work." : "Try again."}`;
  }

  /* ============================================================
     VIDEO VOCAB GAME (Lesson 2)
  ============================================================ */
  const videoVocabItems = [
    { term:"space debris", def:"pieces of material floating in space" },
    { term:"main asteroid belt", def:"region between Mars and Jupiter with many asteroids" },
    { term:"near-Earth asteroid", def:"an asteroid whose orbit comes close to Earth" },
    { term:"carbonaceous (C-type)", def:"rich in carbon compounds, can contain water" },
    { term:"silicious (S-type)", def:"made of silicates (often with iron/magnesium)" },
    { term:"metallic (M-type)", def:"rich in metals like nickel and iron" },
    { term:"platinum-group metals", def:"valuable metals including platinum and related elements" },
    { term:"commodity", def:"a useful resource that can be traded" },
    { term:"radiation shielding", def:"protection against harmful radiation" },
    { term:"to refine", def:"to process raw material into usable material" }
  ];

  function newVideoGame(){
    const grid = document.getElementById("videoGameGrid");
    const fb = document.getElementById("fb_videogame");
    fb.style.display = "none";
    fb.textContent = "";
    grid.innerHTML = "";

    const terms = shuffle(videoVocabItems);
    const allDefs = videoVocabItems.map(x=>x.def);

    terms.forEach((item, idx)=>{
      const qId = "vg2_" + idx;
      const correct = item.def;

      const distractors = pickDistractors(correct, allDefs, 3);
      const options = shuffle([correct, ...distractors]);

      const box = document.createElement("div");
      box.className = "gameQ";
      box.innerHTML = `
        <div class="stepHeader">
          <div><span class="badge">Video Vocab ${idx+1}/10</span></div>
          <div class="hint" style="margin:0;">Choose the correct definition</div>
        </div>
        <div style="font-weight:800; color:#1f3a5f; font-size:1.05rem;">${escapeHtml(item.term)}</div>
        <div class="choices" style="margin-top:8px;">
          ${options.map((c)=>`
            <label>
              <input type="radio" name="${qId}" value="${escapeHtml(c)}">
              ${escapeHtml(c)}
            </label>
          `).join("")}
        </div>
        <input type="hidden" id="${qId}_ans" value="${escapeHtml(correct)}">
      `;
      grid.appendChild(box);
    });
  }

  function gradeVideoGame(){
    const fb = document.getElementById("fb_videogame");
    let score = 0;

    for (let i=0;i<10;i++){
      const qId = "vg2_" + i;
      const correctEl = document.getElementById(qId+"_ans");
      if (!correctEl) continue;
      const correct = correctEl.value || "";
      const pickedEl = document.querySelector(`input[name="${qId}"]:checked`);
      const picked = pickedEl ? pickedEl.value : "";
      if (picked && picked === correct) score++;
    }

    fb.style.display = "block";
    fb.textContent = `Score: ${score}/10. ${score>=8 ? "Excellent." : (score>=6 ? "Good. Try again to improve." : "Try again and learn the key words.")}`;
  }

  /* ============================================================
     INIT
  ============================================================ */
  attachCounters();
  newGame();
  newVideoGame();
  restoreAnswers();
</script>

</body>
</html>
