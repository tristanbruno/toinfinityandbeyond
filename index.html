<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>To Infinity and Beyond ‚Äì Interactive Worksheet</title>

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #0b1d33, #102a44);
      color: #ffffff;
      line-height: 1.6;
    }
    header {
      padding: 24px 16px;
      text-align: center;
      background: radial-gradient(circle at top, #1f3a5f, #0b1d33);
    }
    header h1 { margin: 0 0 8px 0; font-size: 2rem; }
    header p { max-width: 900px; margin: 6px auto; opacity: 0.92; }
    main { padding: 16px; max-width: 980px; margin: auto; }

    .nav {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 0 0 16px 0;
      flex-wrap: wrap;
    }
    .card {
      background: #ffffff;
      color: #000000;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    }
    h2, h3 { color: #1f3a5f; margin-top: 0; }
    a { color: #1f3a5f; word-break: break-word; }

    img {
      max-width: 100%;
      border-radius: 10px;
      margin: 12px 0;
      display: block;
    }

    .figure {
      margin: 12px 0;
      padding: 10px;
      background: #f6f8fc;
      border-radius: 10px;
      border: 1px solid #e3e7f2;
    }
    .figure img {
      width: 100%;
      height: auto;
      margin: 0;
      border-radius: 10px;
    }
    .figure .caption {
      font-size: 0.92rem;
      opacity: 0.85;
      margin-top: 6px;
      color: #1f3a5f;
    }

    label { font-weight: 600; display: block; margin-top: 14px; }

    textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
      resize: vertical;
      box-sizing: border-box;
    }

    button {
      padding: 12px 18px;
      background: #1f3a5f;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { background: #162a45; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .feedback {
      margin-top: 14px;
      padding: 12px;
      border-radius: 8px;
      background: #eef3fa;
      color: #000000;
      display: none;
    }
    .answers {
      margin-top: 14px;
      padding: 14px;
      background: #e0e8f3;
      border-left: 5px solid #1f3a5f;
      display: none;
    }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef3fa;
      color: #1f3a5f;
      font-weight: 600;
      font-size: 0.9rem;
      margin-right: 6px;
    }
    .hint { font-size: 0.95rem; opacity: 0.9; margin-top: 6px; }
    ul { padding-left: 18px; }

    /* Counters */
    .counter{
      font-size: 0.92rem;
      opacity: 0.85;
      margin-top: 6px;
      color: #1f3a5f;
      display:flex;
      justify-content:flex-end;
    }
    .counter.bad{ color:#b00020; font-weight:600; opacity:0.95; }
    .counter.good{ color:#0b6b2c; font-weight:600; opacity:0.95; }

    /* stepper */
    .step {
      display: none;
      border: 1px solid #e3e7f2;
      border-radius: 12px;
      padding: 14px;
      background: #f7f9fe;
      margin-top: 12px;
    }
    .step.active { display: block; }
    .stepHeader {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 8px;
    }
    .badge {
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background:#eef3fa;
      color:#1f3a5f;
      font-weight:700;
      font-size:0.85rem;
      white-space: nowrap;
    }

    /* gate modal */
    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modalBackdrop.show{ display:flex; }
    .modal {
      width: min(520px, 100%);
      background: #ffffff;
      color: #000000;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    .modal input{
      width: 100%;
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-top: 10px;
    }
    .row {
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    /* vocab game */
    .gameGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .gameQ{
      padding: 12px;
      border: 1px solid #e3e7f2;
      border-radius: 12px;
      background: #f7f9fe;
    }
    .choices label{
      display:block;
      font-weight: 500;
      margin-top: 8px;
    }
    .smallBtn{
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 8px;
    }
  </style>
</head>

<body>

<header>
  <h1>üöÄ To Infinity and Beyond</h1>
  <p><span class="pill">Key question</span> Space conquest: a way to make money, a competition or a necessity?</p>
  <p><span class="pill">Theme</span> Space conquest: scientific innovations and responsibility</p>
</header>

<main>
  <div class="nav">
    <button type="button" onclick="showPage('worksheet')">Lesson 1 ‚Äì Worksheet (start here)</button>
    <button type="button" onclick="showLesson2()">Lesson 2 ‚Äì Video (locked)</button>
    <button type="button" onclick="showPage('vocab')" id="btnVocab" style="display:none;">Vocabulary game</button>
  </div>

  <!-- PAGE: WORKSHEET -->
  <section id="page-worksheet">
    <div class="card">
      <h2>Before you start</h2>
      <p>Use the following resource to find relevant information before answering the questions:</p>
      <p>
        <a href="https://www.spacefoundation.org/space_brief/us-space-law/" target="_blank" rel="noopener noreferrer">
          https://www.spacefoundation.org/space_brief/us-space-law/
        </a>
      </p>
      <p class="hint">Tip: focus on key ideas about the role of the government, private companies, and resource rights.</p>
    </div>

    <div class="card">
      <h2>Lesson 1 ‚Äì Asteroid Mining (Worksheet)</h2>
      <p class="hint">
        <strong>How it works:</strong> Answer <strong>one question at a time</strong>.
        You must write at least <strong>15 words</strong> and use <strong>key ideas</strong>.
      </p>

      <div class="figure">
        <img src="images/asteroid-infographic.jpeg" alt="Asteroid mining infographic" />
        <div class="caption">Study this infographic carefully before answering questions 1 and 2.</div>

        <!-- Step 1 -->
        <div class="step active" id="step-q1">
          <div class="stepHeader">
            <div><span class="badge">Question 1/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words </div>
          </div>

          <label>1. Why are the 1958 Space Act and the 2015 Space Act both relevant today?</label>
          <textarea id="q1" rows="5" placeholder="Write in full sentences..."></textarea>
          <div class="counter" id="c_q1">Words: 0/15</div>

          <button type="button" onclick="submitOne('q1')">Submit Q1</button>
          <button type="button" class="smallBtn" id="next_q1" onclick="goNext('q1')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_q1"></div>

          <div class="answers" id="ans_q1">
            <h3>Correction (Q1)</h3>
            <p>The 1958 Space Act set up a public framework for U.S. space activities, while the 2015 U.S. Commercial Space Launch Competitiveness Act supports commercial involvement and resource rights. Together, they shape today‚Äôs debate about space as a public mission and a commercial opportunity.</p>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="step" id="step-q2">
          <div class="stepHeader">
            <div><span class="badge">Question 2/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words </div>
          </div>

          <label>2. Explain the different steps of the process shown in the infographic.</label>
          <textarea id="q2" rows="5" placeholder="Describe the steps clearly..."></textarea>
          <div class="counter" id="c_q2">Words: 0/15</div>

          <button type="button" onclick="submitOne('q2')">Submit Q2</button>
          <button type="button" class="smallBtn" id="next_q2" onclick="goNext('q2')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_q2"></div>

          <div class="answers" id="ans_q2">
            <h3>Correction (Q2)</h3>
            <p>Possible steps: launch a spacecraft ‚Üí locate/approach an asteroid ‚Üí analyze composition ‚Üí confirm valuable resources (e.g., water) ‚Üí extract/collect materials ‚Üí use them in space or send information/resources back.</p>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="step" id="step-q3">
          <div class="stepHeader">
            <div><span class="badge">Question 3/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words </div>
          </div>

          <label>3. Why is water important in space?</label>
          <textarea id="q3" rows="4" placeholder="Use at least two reasons..."></textarea>
          <div class="counter" id="c_q3">Words: 0/15</div>

          <button type="button" onclick="submitOne('q3')">Submit Q3</button>
          <button type="button" class="smallBtn" id="next_q3" onclick="goNext('q3')" style="display:none; margin-left:10px;">Next</button>

          <div class="feedback" id="fb_q3"></div>

          <div class="answers" id="ans_q3">
            <h3>Correction (Q3)</h3>
            <p>Water is essential for life support (drinking, oxygen) and it can be processed to make rocket propellant, enabling longer missions and refuelling in space.</p>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="step" id="step-q4">
          <div class="stepHeader">
            <div><span class="badge">Question 4/4</span></div>
            <div class="hint" style="margin:0;">Minimum: 15 words </div>
          </div>

          <label>4. Does the document support or oppose asteroid mining? Why?</label>
          <textarea id="q4" rows="5" placeholder="State a position and justify with evidence..."></textarea>
          <div class="counter" id="c_q4">Words: 0/15</div>

          <button type="button" onclick="submitOne('q4')">Submit Q4</button>
          <button type="button" class="smallBtn" id="next_q4" onclick="goNext('q4')" style="display:none; margin-left:10px;">Finish</button>

          <div class="feedback" id="fb_q4"></div>

          <div class="answers" id="ans_q4">
            <h3>Correction (Q4)</h3>
            <p>Many such documents are generally supportive/optimistic because they highlight feasibility and benefits (especially water). A critical reading can also note what is missing (risks, ethics, environment). Any position is acceptable if justified with evidence from the document.</p>
          </div>
        </div>

        <!-- End message -->
        <div class="card" id="lesson1DoneCard" style="display:none;">
          <h2>Lesson 1 completed ‚úÖ</h2>
          <p><strong>Write that in your copybook ! ;)</strong></p>

          <h3>Summary / Course</h3>
          <p id="courseSummary" class="hint" style="opacity:1; color:#000;"></p>

          <p class="hint">Lesson 2 is locked with a code. If you finish early, use the vocabulary game.</p>
          <div class="row">
            <button type="button" class="smallBtn" onclick="showPage('vocab')">Go to Vocabulary game</button>
            <button type="button" class="smallBtn" onclick="showLesson2()">Unlock Lesson 2</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- PAGE: VIDEO -->
  <section id="page-video" style="display:none;">
    <div class="card">
      <h2>Lesson 2 ‚Äì Video: Asteroid Mining</h2>
      <p class="hint"><strong>This is Lesson 2.</strong> Only work on this section after completing Lesson 1.</p>

      <div style="position:relative; padding-top:56.25%; border-radius:12px; overflow:hidden;">
        <iframe
          src="https://www.youtube.com/embed/erF17yO9VsE"
          title="Asteroid Mining (YouTube)"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
          style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;">
        </iframe>
      </div>

      <div class="card" style="margin-top:14px;">
        <h3>Activities (Lesson 2)</h3>

        <label>A1. In 2‚Äì3 sentences, explain what asteroid mining is.</label>
        <textarea id="v1" rows="3" placeholder="Write your answer..."></textarea>
        <div class="counter" id="c_v1">Words: 0/15</div>

        <label>A2. List two reasons why companies might want to mine asteroids.</label>
        <textarea id="v2" rows="2" placeholder="Write your answer..."></textarea>
        <div class="counter" id="c_v2">Words: 0/15</div>

        <label>A3. True or False (justify briefly): Mining in space could help missions go further.</label>
        <textarea id="v3" rows="2" placeholder="True/False + justification..."></textarea>
        <div class="counter" id="c_v3">Words: 0/15</div>

        <label>A4. Multiple choice: Which resource is often described as especially useful in space?</label>
        <div style="margin-top:6px;">
          <label style="font-weight:normal; margin-top:8px;"><input type="radio" name="v4" value="gold"> Gold</label><br>
          <label style="font-weight:normal; margin-top:8px;"><input type="radio" name="v4" value="water"> Water</label><br>
          <label style="font-weight:normal; margin-top:8px;"><input type="radio" name="v4" value="diamonds"> Diamonds</label><br>
          <label style="font-weight:normal; margin-top:8px;"><input type="radio" name="v4" value="coal"> Coal</label>
        </div>

        <label>A5. In your opinion, is asteroid mining mainly about money, competition, or necessity? Explain.</label>
        <textarea id="v5" rows="3" placeholder="Write your opinion + one argument..."></textarea>
        <div class="counter" id="c_v5">Words: 0/15</div>

        <button type="button" onclick="submitLesson2()">Submit Lesson 2</button>
        <div class="feedback" id="fb_l2"></div>

        <div class="answers" id="ans_l2">
          <h3>Correction / Suggested answers</h3>
          <p><strong>A1.</strong> Asteroid mining is the idea of extracting useful resources (like water, metals, or minerals) from asteroids rather than only from Earth.</p>
          <p><strong>A2.</strong> Examples: rare metals for industry; water for life support and fuel; reducing costs by using resources already in space; supporting long-term exploration.</p>
          <p><strong>A3.</strong> True: if resources are available in space, spacecraft can refuel or get supplies without returning to Earth, making longer missions easier.</p>
          <p><strong>A4.</strong> Water (because it supports life and can be turned into oxygen and fuel).</p>
          <p><strong>A5.</strong> Accept any well-argued answer (money/competition/necessity) if justified with ideas from the video.</p>
          <p style="font-weight:bold; margin-top:16px;">‚úèÔ∏è Write that in your copybook! ;)</p>
        </div>

      </div>
    </div>
  </section>

  <!-- PAGE: VOCAB GAME -->
  <section id="page-vocab" style="display:none;">
    <div class="card">
      <h2>Vocabulary game (when you finish early)</h2>
      <p class="hint">Do this quietly while waiting for correction. Try to get 6/6.</p>

      <div class="gameGrid" id="gameGrid"></div>

      <div class="row">
        <button type="button" class="smallBtn" onclick="gradeGame()">Check my score</button>
        <button type="button" class="smallBtn" onclick="newGame()">New round</button>
        <button type="button" class="smallBtn" onclick="showPage('worksheet')">Back to Lesson 1</button>
      </div>

      <div class="feedback" id="fb_game"></div>
    </div>
  </section>

</main>

<!-- Lesson 2 code modal -->
<div class="modalBackdrop" id="codeModal">
  <div class="modal">
    <h2>Unlock Lesson 2</h2>
    <p>Enter the code given by your teacher.</p>
    <input id="codeInput" type="password" placeholder="Enter code‚Ä¶" autocomplete="off" />
    <div class="row">
      <button type="button" onclick="tryUnlock()">Unlock</button>
      <button type="button" onclick="closeModal()">Cancel</button>
    </div>
    <div class="feedback" id="fb_code" style="display:none;"></div>
  </div>
</div>

<script>
  /* -------------------------
     NAV + LESSON 2 LOCK
  --------------------------*/
  const LESSON2_CODE = "misterbruno";

  function showPage(which){
    const pages = ["worksheet","video","vocab"];
    pages.forEach(p => {
      const el = document.getElementById("page-" + p);
      if (el) el.style.display = (p === which ? "block" : "none");
    });
    window.scrollTo({top: 0, behavior: "smooth"});
  }

  function openModal(){
    document.getElementById("codeModal").classList.add("show");
    const fb = document.getElementById("fb_code");
    fb.style.display = "none";
    fb.textContent = "";
    document.getElementById("codeInput").value = "";
    document.getElementById("codeInput").focus();
  }

  function closeModal(){
    document.getElementById("codeModal").classList.remove("show");
  }

  function lesson2Unlocked(){
    try { return sessionStorage.getItem("lesson2Unlocked") === "1"; }
    catch(e){ return false; }
  }

  function markLesson2Unlocked(){
    try { sessionStorage.setItem("lesson2Unlocked","1"); } catch(e){}
  }

  function showLesson2(){
    const l1done = (function(){
      try { return localStorage.getItem("lesson1Done") === "1"; } catch(e){ return false; }
    })();

    if (!l1done){
      alert("Finish Lesson 1 first.");
      showPage("worksheet");
      return;
    }
    if (!lesson2Unlocked()){
      openModal();
      return;
    }
    showPage("video");
  }

  function tryUnlock(){
    const v = (document.getElementById("codeInput").value || "").trim().toLowerCase();
    const fb = document.getElementById("fb_code");
    fb.style.display = "block";

    if (v === LESSON2_CODE){
      fb.textContent = "Unlocked ‚úÖ";
      markLesson2Unlocked();
      setTimeout(() => {
        closeModal();
        showPage("video");
      }, 400);
    } else {
      fb.textContent = "Wrong code. Try again.";
    }
  }

  /* -------------------------
     HELPERS
  --------------------------*/
  const MIN_WORDS = 15;

  function norm(s){ return (s||"").toLowerCase().trim(); }

  function wordsCount(text){
    const t = norm(text);
    if (!t) return 0;
    return t.split(/\s+/).filter(Boolean).length;
  }

  function hasAny(text, list){
    const t = norm(text);
    return list.some(k => t.includes(k));
  }

  function countMatches(text, keywords){
    const t = norm(text);
    return keywords.reduce((acc,k)=>acc+(t.includes(k)?1:0),0);
  }

  /* -------------------------
     ANTI-CHARABIA (SOFT BUT REAL GATE)
     - min words: 15 (no maximum)
     - spam detection
     - keywords required (minimal)
  --------------------------*/
  function isSpam(text){
    const raw = (text||"").trim();
    if (raw.length < 10) return true;

    const t = raw.toLowerCase().replace(/[\s\W_]+/g,"");
    if (t.length < 10) return true;

    let run = 1;
    for (let i=1;i<t.length;i++){
      if (t[i]===t[i-1]) { run++; if (run>=9) return true; }
      else run = 1;
    }

    if (t.length>=14){
      const a=t[0], b=t[1];
      if (a && b){
        let ok=true;
        for (let i=0;i<t.length;i++){
          if (t[i] !== (i%2===0 ? a : b)) { ok=false; break; }
        }
        if (ok) return true;
      }
    }

    const uniq = new Set(t.split(""));
    const ratio = uniq.size / t.length;
    if (ratio < 0.16) return true;

    return false;
  }

  const gateRules = {
    // Lesson 1
    q1: { minWords: MIN_WORDS, keywordsAnyMin: { list: ["1958","2015","space act","commercial","private","companies","law","resources","rights"], n: 2 } },
    q2: { minWords: MIN_WORDS, keywordsAnyMin: { list: ["launch","spacecraft","asteroid","approach","locate","find","analyze","analysis","composition","extract","collect","process","steps"], n: 3 } },
    q3: { minWords: MIN_WORDS, keywordsAnyMin: { list: ["oxygen","life support","drink","drinking","fuel","propellant","rocket","refuel","hydrogen"], n: 2 } },
    q4: { minWords: MIN_WORDS, keywordsAnyMin: { list: ["support","oppose","because","since","evidence","benefit","risk","ethics","environment","feasible"], n: 2 } },

    // Lesson 2
    v1: { minWords: MIN_WORDS, keywordsAnyMin: { list: ["asteroid","mining","mine","extract","resources","metals","water","materials"], n: 2 } },
    v2: { minWords: MIN_WORDS, keywordsAnyMin: { list: ["metals","water","fuel","profit","money","cost","missions","industry","resources","exploration"], n: 2 } },
    v3: { minWords: MIN_WORDS, keywordsAnyMin: { list: ["true","false","because","since","so","therefore"], n: 1 } },
    v5: { minWords: MIN_WORDS, keywordsAnyMin: { list: ["money","profit","competition","race","necessity","need","because","since","missions","resources"], n: 2 } }
  };

  function passesGate(fieldId, value){
    const v = (value||"").trim();
    const r = gateRules[fieldId] || {};

    if (isSpam(v)) {
      return { ok:false, reason:"Your answer looks incomplete (random letters / repetition). Write full sentences." };
    }

    const wc = wordsCount(v);
    if (r.minWords && wc < r.minWords){
      return { ok:false, reason:`Write at least ${r.minWords} words (no maximum).` };
    }

    if (r.keywordsAnyMin){
      const hits = countMatches(v, r.keywordsAnyMin.list);
      if (hits < r.keywordsAnyMin.n){
        return { ok:false, reason:"Add key ideas from the lesson (specific vocabulary)." };
      }
    }

    return { ok:true, reason:"" };
  }

  /* -------------------------
     SOFT CORRECTNESS (for showing correction)
     - gate decides access
     - this decides whether we show correction or not
  --------------------------*/
  function gradeAnswer(fieldId, value){
    const t = norm(value);

    let score = 0;
    let target = 0;

    if (fieldId === "q1"){
      target = 3;
      if (hasAny(t, ["1958","space act"])) score++;
      if (hasAny(t, ["2015","commercial","competitiveness","launch competitiveness"])) score++;
      if (hasAny(t, ["private","companies","resources","rights","mining"])) score++;
      if (hasAny(t, ["government","public","framework","law","policy","nasa"])) score++;
    }

    if (fieldId === "q2"){
      target = 3;
      const stepKw = ["launch","spacecraft","probe","locate","find","approach","asteroid","analy","analyze","analysis","composition","extract","mine","mining","collect","process","return","use in space"];
      const n = countMatches(t, stepKw);
      score = (n >= 3) ? 3 : n;
    }

    if (fieldId === "q3"){
      target = 2;
      const life = hasAny(t, ["drink","drinking","life support","oxygen","air"]);
      const fuel = hasAny(t, ["fuel","propellant","rocket","refuel","hydrogen"]);
      if (life) score++;
      if (fuel) score++;
    }

    if (fieldId === "q4"){
      target = 3;
      const stance = hasAny(t, ["support","oppose","pro","con","against","for"]);
      const justify = hasAny(t, ["because","since","therefore","so"]);
      const evidence = hasAny(t, ["benefit","risk","ethics","environment","feasible","water","missions","cost"]);
      if (stance) score++;
      if (justify) score++;
      if (evidence) score++;
    }

    if (fieldId === "v1"){
      target = 2;
      if (hasAny(t, ["asteroid"])) score++;
      if (hasAny(t, ["mining","mine","extract","resources","metals","water","materials"])) score++;
    }

    if (fieldId === "v2"){
      target = 1; // very soft: if they wrote enough, ok
      score = 1;
    }

    if (fieldId === "v3"){
      target = 2;
      if (hasAny(t, ["true","false"])) score++;
      if (hasAny(t, ["because","since","so","therefore"])) score++;
    }

    if (fieldId === "v5"){
      target = 2;
      if (hasAny(t, ["money","profit","competition","race","necessity","need"])) score++;
      if (hasAny(t, ["because","since","so","therefore","argument","reason"])) score++;
    }

    const correct = (target === 0) ? true : (score >= target);
    return {
      correct,
      note: correct
        ? "‚úÖ OK. Wait for correction with the class."
        : "‚ö†Ô∏è Not fully correct / incomplete. Read the correction below, then improve your answer in your copybook."
    };
  }

  /* -------------------------
     COUNTERS
  --------------------------*/
  const counterMap = [
    { id:"q1", counter:"c_q1" },
    { id:"q2", counter:"c_q2" },
    { id:"q3", counter:"c_q3" },
    { id:"q4", counter:"c_q4" },
    { id:"v1", counter:"c_v1" },
    { id:"v2", counter:"c_v2" },
    { id:"v3", counter:"c_v3" },
    { id:"v5", counter:"c_v5" }
  ];

  function updateCounter(fieldId){
    const cfg = counterMap.find(x=>x.id===fieldId);
    if(!cfg) return;
    const el = document.getElementById(cfg.id);
    const c  = document.getElementById(cfg.counter);
    if(!el||!c) return;

    const wc = wordsCount(el.value);
    c.textContent = `Words: ${wc}/${MIN_WORDS}`;
    c.classList.remove("bad","good");

    if (el.value.trim().length===0) return;

    if (isSpam(el.value) || wc < MIN_WORDS) c.classList.add("bad");
    else c.classList.add("good");
  }

  function attachCounters(){
    counterMap.forEach(cfg=>{
      const el = document.getElementById(cfg.id);
      if(!el) return;
      el.addEventListener("input", ()=>updateCounter(cfg.id));
      el.addEventListener("blur",  ()=>updateCounter(cfg.id));
      updateCounter(cfg.id);
    });
  }

  /* -------------------------
     STEP CONTROL
  --------------------------*/
  const stepOrder = ["q1","q2","q3","q4"];

  function setActiveStep(id){
    stepOrder.forEach(q => {
      const box = document.getElementById("step-" + q);
      if (box) box.classList.toggle("active", q === id);
    });
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function unlockVocabButton(){
    const b = document.getElementById("btnVocab");
    if (b) b.style.display = "inline-block";
  }

  function showCorrection(fieldId, show){
    const ans = document.getElementById("ans_" + fieldId);
    if (ans) ans.style.display = show ? "block" : "none";
  }

  function showNextButton(fieldId){
    const btn = document.getElementById("next_" + fieldId);
    if (btn) btn.style.display = "inline-block";
  }

  function hideNextButton(fieldId){
    const btn = document.getElementById("next_" + fieldId);
    if (btn) btn.style.display = "none";
  }

  function goNext(fieldId){
    const idx = stepOrder.indexOf(fieldId);
    if (idx >= 0 && idx < stepOrder.length - 1){
      setActiveStep(stepOrder[idx+1]);
      return;
    }
    finishLesson1();
  }

  function submitOne(fieldId){
    const el = document.getElementById(fieldId);
    const fb = document.getElementById("fb_" + fieldId);
    if (!el || !fb) return;

    const value = el.value.trim();
    fb.style.display = "block";

    showCorrection(fieldId, false);

    // HARD GATE: if fails, they cannot proceed
    const gate = passesGate(fieldId, value);
    if (!gate.ok){
      fb.textContent = "Not yet. " + gate.reason;
      hideNextButton(fieldId);
      return;
    }

    // Gate passed => allow next
    const g = gradeAnswer(fieldId, value);
    fb.textContent = g.note;
    unlockVocabButton();
    showNextButton(fieldId);

    // Show correction ONLY if not correct (soft grading)
    if (!g.correct){
      showCorrection(fieldId, true);
    }
  }

  function finishLesson1(){
    try { localStorage.setItem("lesson1Done","1"); } catch(e){}
    document.getElementById("lesson1DoneCard").style.display = "block";

    const summary =
      "The 1958 Space Act created a public framework for U.S. space activities, while the 2015 Commercial Space Launch Competitiveness Act supports private companies and resource rights. " +
      "Asteroid mining can involve launching a spacecraft, locating and approaching an asteroid, analysing its composition, confirming valuable resources (especially water), and extracting/collecting materials to use in space. " +
      "Water is crucial because it supports life (drinking/oxygen) and can be processed into propellant for refuelling, making longer missions possible. " +
      "Many documents are optimistic about asteroid mining because they highlight feasibility and benefits, but a critical view can also mention risks, ethics, and environmental issues. " +
      "In all cases, a clear opinion must be justified with evidence.";
    const p = document.getElementById("courseSummary");
    if (p) p.textContent = summary;

    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  /* -------------------------
     LESSON 2 SUBMISSION (GATED)
  --------------------------*/
  function getRadioValue(name){
    const el = document.querySelector('input[name="' + name + '"]:checked');
    return el ? el.value : '';
  }

  function submitLesson2(){
    const fb = document.getElementById("fb_l2");
    const ans = document.getElementById("ans_l2");

    const v1 = (document.getElementById("v1").value || "").trim();
    const v2 = (document.getElementById("v2").value || "").trim();
    const v3 = (document.getElementById("v3").value || "").trim();
    const v4 = getRadioValue("v4");
    const v5 = (document.getElementById("v5").value || "").trim();

    fb.style.display = "block";
    if (ans) ans.style.display = "none";

    if (!v1 || !v2 || !v3 || !v4 || !v5){
      fb.textContent = "Please answer all activities before submitting.";
      return;
    }

    // Gate each text field
    const g1 = passesGate("v1", v1);
    const g2 = passesGate("v2", v2);
    const g3 = passesGate("v3", v3);
    const g5 = passesGate("v5", v5);

    if (!g1.ok) { fb.textContent = "Not yet (A1). " + g1.reason; return; }
    if (!g2.ok) { fb.textContent = "Not yet (A2). " + g2.reason; return; }
    if (!g3.ok) { fb.textContent = "Not yet (A3). " + g3.reason; return; }
    if (!g5.ok) { fb.textContent = "Not yet (A5). " + g5.reason; return; }

    // MCQ check + show correction if needed
    const soft1 = gradeAnswer("v1", v1);
    const soft3 = gradeAnswer("v3", v3);
    const soft5 = gradeAnswer("v5", v5);

    const problems = [];
    if (!soft1.correct) problems.push("A1 needs a clearer definition (what it is + resources).");
    if (v4 !== "water") problems.push("A4: choose the option that matches the video (hint: life + fuel).");
    if (!soft3.correct) problems.push("A3: write True/False + a short justification.");
    if (!soft5.correct) problems.push("A5: give an opinion + justification.");

    if (problems.length > 0){
      fb.textContent = "‚ö†Ô∏è Not fully correct / incomplete. Read the correction below, then improve your answer in your copybook.";
      if (ans) ans.style.display = "block";
      unlockVocabButton();
      return;
    }

    fb.textContent = "‚úÖ OK. Wait for correction with the class.";
    if (ans) ans.style.display = "block";
    unlockVocabButton();
  }

  /* -------------------------
     VOCAB GAME
  --------------------------*/
  const vocabItems = [
    { term:"to extract", def:"to remove (a material) from something" },
    { term:"resources", def:"useful materials that can be used or sold" },
    { term:"to refuel", def:"to fill a vehicle with fuel again" },
    { term:"propellant", def:"substance used to move a rocket forward" },
    { term:"life support", def:"systems that keep humans alive (air/water/etc.)" },
    { term:"to launch", def:"to send a rocket/spacecraft into space" }
  ];

  function shuffle(arr){
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function newGame(){
    const grid = document.getElementById("gameGrid");
    const fb = document.getElementById("fb_game");
    fb.style.display = "none";
    fb.textContent = "";
    grid.innerHTML = "";

    const terms = shuffle(vocabItems);
    const defs  = shuffle(vocabItems.map(x=>x.def));

    terms.forEach((item, idx)=>{
      const qId = "vg_" + idx;
      const correct = item.def;

      const choices = shuffle([correct, defs[(idx+1)%defs.length], defs[(idx+2)%defs.length], defs[(idx+3)%defs.length]])
        .slice(0,4);

      const box = document.createElement("div");
      box.className = "gameQ";
      box.innerHTML = `
        <div class="stepHeader">
          <div><span class="badge">Vocab ${idx+1}/6</span></div>
          <div class="hint" style="margin:0;">Choose the correct definition</div>
        </div>
        <div style="font-weight:800; color:#1f3a5f; font-size:1.05rem;">${item.term}</div>
        <div class="choices" style="margin-top:8px;">
          ${choices.map((c,i)=>`
            <label>
              <input type="radio" name="${qId}" value="${escapeHtml(c)}">
              ${escapeHtml(c)}
            </label>
          `).join("")}
        </div>
        <input type="hidden" id="${qId}_ans" value="${escapeHtml(correct)}">
      `;
      grid.appendChild(box);
    });
  }

  function gradeGame(){
    const fb = document.getElementById("fb_game");
    let score = 0;

    for (let i=0;i<6;i++){
      const qId = "vg_" + i;
      const correct = (document.getElementById(qId+"_ans").value || "");
      const pickedEl = document.querySelector(`input[name="${qId}"]:checked`);
      const picked = pickedEl ? pickedEl.value : "";

      if (picked && picked === correct) score++;
    }

    fb.style.display = "block";
    fb.textContent = `Score: ${score}/6. ${score>=5 ? "Great work." : "Try again."}`;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  /* init */
  attachCounters();
  newGame();
</script>

</body>
</html>
